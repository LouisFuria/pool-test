<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FURIA DEX · Base Sepolia</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
<link rel="preconnect" href="https://unpkg.com" crossorigin />
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<style>
  :root{--bg:#0a0f1a;--panel:#101827;--muted:#8b97ad;--text:#e6ecff;--primary:#7c5cff;--accent:#a78bfa;--ok:#22c55e;--bad:#ef4444;}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.3 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1150px;margin:28px auto;padding:0 16px}
  .row{display:flex;gap:18px;flex-wrap:wrap}
  .card{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
  .nav{display:flex;gap:12px;align-items:center;margin:6px 0 22px}
  .tag{padding:6px 10px;border-radius:999px;background:#141c2e;color:var(--muted);font-size:13px}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#1f2937}
  .btn.ghost{background:#121a2b}
  .input,select{width:100%;background:#0f1626;border:1px solid #202a40;color:var(--text);padding:12px 14px;border-radius:12px;outline:0}
  .title{font-weight:800;letter-spacing:.2px}
  .kpi{display:flex;justify-content:space-between;align-items:center;background:#0e1627;padding:14px 16px;border-radius:12px;border:1px solid #1c263c}
  h1{font-size:28px;margin:0 0 2px}
  h2{font-size:18px;margin:0 0 12px}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .pill{padding:8px 12px;border-radius:999px;background:#141c2e;border:1px solid #1c263c}
  .tabs{display:flex;gap:10px;margin:18px 0}
  .tab{padding:8px 14px;border-radius:10px;background:#0f1626;border:1px solid #1d2842;cursor:pointer}
  .tab.active{background:var(--primary);border-color:transparent}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:14px 10px;border-bottom:1px solid #1a2338}
  .right{text-align:right}
  .toast{position:fixed;bottom:20px;right:20px;background:#0f1626;border:1px solid #26314d;padding:12px 16px;border-radius:12px;color:#e6ecff;max-width:380px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
    <div>
      <h1>FURIA DEX <span class="muted">· Base Sepolia</span></h1>
      <div class="muted" style="font-size:13px">Swap (10 pts/$) · Pools (1 pt/$/min) · Vaults (1 pt/$/min) · Leaderboard</div>
    </div>
    <div class="row" style="gap:10px">
      <div id="netTag" class="tag">Réseau: —</div>
      <button id="btnConnect" class="btn">Connect Wallet</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="swap">Swap</button>
    <button class="tab" data-tab="pools">Pools</button>
    <button class="tab" data-tab="vaults">Vaults</button>
    <button class="tab" data-tab="leader">Leaderboard</button>
  </div>

  <!-- SWAP -->
  <section id="tab-swap">
    <div class="grid">
      <div class="card">
        <h2 class="title">SWAP ETH ↔ USDC · <span class="muted">Règle points : 10 pts / $ swapé</span></h2>
        <div class="row" style="gap:10px;margin-top:6px">
          <select class="input" id="swapFrom" style="max-width:160px">
            <option>ETH</option><option>USDC</option>
          </select>
          <button id="btnFlip" class="btn ghost" title="Inverser" style="width:52px">⇄</button>
          <select class="input" id="swapTo" style="max-width:160px">
            <option>USDC</option><option>ETH</option>
          </select>
        </div>
        <div style="margin:10px 0">
          <input id="swapAmount" class="input" placeholder="0.0" inputmode="decimal" />
        </div>
        <div class="row" style="gap:10px">
          <button class="btn ghost" data-q="25">25%</button>
          <button class="btn ghost" data-q="50">50%</button>
          <button class="btn ghost" data-q="75">75%</button>
          <button class="btn ghost" data-q="100">100%</button>
        </div>
        <div style="margin:14px 0 6px" class="muted">You Receive</div>
        <div id="youReceive" class="kpi"><div>—</div><div class="muted" id="slipNote"></div></div>
        <div class="row" style="justify-content:space-between;align-items:center;margin-top:12px">
          <div class="muted" id="balanceLine">Solde: —</div>
          <button id="btnSwap" class="btn">Swap</button>
        </div>
      </div>

      <div class="card">
        <h2 class="title">INFOS (SWAP)</h2>
        <div class="kpi"><div class="muted">Prix ETH/USD</div><div id="priceKpi" class="title">$ —</div></div>
        <div class="kpi" style="margin-top:10px"><div class="muted">Frais</div><div id="feeKpi" class="title">—</div></div>
        <div class="kpi" style="margin-top:10px"><div class="muted">TVL (équiv. ETH)</div><div id="tvlSwapEth" class="title">—</div></div>
      </div>
    </div>
  </section>

  <!-- POOLS -->
  <section id="tab-pools" style="display:none">
    <div class="grid">
      <div class="card">
        <div class="kpi"><div class="muted">TVL (équiv. ETH)</div><div id="tvlPools" class="title">—</div></div>
      </div>
      <div class="card">
        <div class="kpi"><div class="muted">Volume ~24h</div><div id="vol24" class="title">$0</div></div>
      </div>
      <div class="card">
        <div class="kpi"><div class="muted">Mes points (swap)</div><div id="mySwapPts" class="title">0</div></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2 class="title">POOLS (POINTS : 1 pt / $ / min)</h2>
      <table class="table" id="tblPools">
        <thead><tr><th>PAIR</th><th class="right">APY</th><th class="right">TVL (ETH)</th><th class="right">POINTS RÈGLE</th><th class="right"></th></tr></thead>
        <tbody>
          <tr>
            <td>ETH / USDC</td>
            <td class="right">20%</td>
            <td class="right" id="rowPoolTvlEth">—</td>
            <td class="right">1 pt / $ / min</td>
            <td class="right"><button class="btn" id="btnAddPool">ADD</button></td>
          </tr>
        </tbody>
      </table>
      <div class="muted" style="margin-top:10px">⚠️ Dépôt “Pools” = même contrat que Vault. L’onglet <b>Vaults</b> permet de déposer.<br/>Ici le bouton ADD ouvre un dépôt double-sided auto 50/50.</div>
    </div>
  </section>

  <!-- VAULTS -->
  <section id="tab-vaults" style="display:none">
    <div class="grid">
      <div class="card">
        <h2 class="title">Vault ETH</h2>
        <div class="kpi"><div class="muted">APY</div><div class="title">25%</div></div>
        <div class="muted" style="margin-top:10px">Règle points: <b>1 pt / $ / min</b> · refresh 10s</div>
        <div class="row" style="margin-top:12px;gap:10px">
          <input id="depEthAmt" class="input" placeholder="Montant en ETH (ex. 0.1)" />
          <button id="btnDepEth" class="btn">Déposer</button>
        </div>
      </div>
      <div class="card">
        <h2 class="title">Vault USDC</h2>
        <div class="kpi"><div class="muted">APY</div><div class="title">25%</div></div>
        <div class="muted" style="margin-top:10px">Règle points: <b>1 pt / $ / min</b> · refresh 10s</div>
        <div class="row" style="margin-top:12px;gap:10px">
          <input id="depUsdcAmt" class="input" placeholder="Montant en USDC (ex. 200)" />
          <button id="btnDepUsdc" class="btn">Déposer</button>
        </div>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="tab-leader" style="display:none">
    <div class="card">
      <h2 class="title">LEADERBOARD (VAULT POINTS)</h2>
      <table class="table" id="tblLb">
        <thead><tr><th>#</th><th>ADRESSE</th><th class="right">POINTS</th></tr></thead>
        <tbody id="lbBody"><tr><td colspan="3" class="muted">Chargement…</td></tr></tbody>
      </table>
      <div class="muted">Règle: <b>1 pt / $ / min</b> (lecture on-chain via <code>pointsOf()</code>, refresh 10s).</div>
    </div>
  </section>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ========= Config ========= */
const SWAP_ADDRESS  = "0x9965B8ef813E6247c6788AF7836756a579474484";
const VAULT_ADDRESS = "0xfC39B74a0c3AD291f88224ec620410c32f3659e4";
const BASE_SEPOLIA  = 84532;

/* ========= ABIs ========= */
const SWAP_ABI = [
  "function ethUsd() view returns (uint256)",  // 8 décimales
  "function feeBps() view returns (uint256)",
  "function USDC() view returns (address)",
  "function swapETHforUSDC() payable returns (uint256 usdcOut)",
  "function swapUSDCforETH(uint256 usdcIn) returns (uint256 ethOut)",
  // events (pour points swap si besoin)
  "event SwapETHforUSDC(address indexed user,uint256 ethIn,uint256 usdcOut,uint256 price8,uint256 feeBps)",
  "event SwapUSDCforETH(address indexed user,uint256 usdcIn,uint256 ethOut,uint256 price8,uint256 feeBps)"
];

const VAULT_ABI = [
  // vues
  "function totalETH() view returns (uint256)",
  "function totalUSDC() view returns (uint256)",     // 6 déc.
  "function userETH(address) view returns (uint256)",
  "function userUSDC(address) view returns (uint256)",
  "function pointsOf(address) view returns (uint256)", // points en unités entières (ou *1e6 sur ton mock)
  // dépôts
  "function depositETH() payable",
  "function depositUSDC(uint256 amount)",
  // events pour découvrir les participants
  "event DepositETH(address indexed user,uint256 amount)",
  "event DepositUSDC(address indexed user,uint256 amount)",
  "event WithdrawETH(address indexed user,uint256 amount)",
  "event WithdrawUSDC(address indexed user,uint256 amount)"
];

const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

/* ========= Ethers setup ========= */
const rpcs = {
  84532: "https://sepolia.base.org"
};
let provider = new ethers.providers.JsonRpcProvider(rpcs[84532]);
let web3, signer, me;

const swap  = new ethers.Contract(SWAP_ADDRESS, SWAP_ABI, provider);
const vault = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, provider);
let USDC, usdcDecimals = 6;

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display="none", 3500); };

(async function init(){
  try{
    const usdcAddr = await swap.USDC();
    USDC = new ethers.Contract(usdcAddr, ERC20_ABI, provider);
    usdcDecimals = await USDC.decimals();
  }catch(e){ console.warn("USDC decimals read failed, defaulting to 6"); }

  // restore last account (cosmétique)
  if(localStorage.getItem("furia_autoconnect")==="1" && window.ethereum){
    try{ await connect(true); }catch{}
  }
  wireUI();
  await refreshStatic();
  setInterval(refreshTvlAndLb, 10_000);
})();

/* ========= UI wiring ========= */
function wireUI(){
  // tabs
  $$(".tab").forEach(btn=>{
    btn.onclick = ()=>{
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const k = btn.dataset.tab;
      ["swap","pools","vaults","leader"].forEach(id=>{
        $("#tab-"+id).style.display = (id===k)?"block":"none";
      });
    };
  });

  $("#btnConnect").onclick = ()=>connect();

  // swap selectors
  $("#btnFlip").onclick = ()=>{
    const a=$("#swapFrom"), b=$("#swapTo");
    const tmp=a.value; a.value=b.value; b.value=tmp;
    updateQuote();
  };
  $("#swapFrom").onchange = updateQuote;
  $("#swapTo").onchange   = updateQuote;
  $("#swapAmount").oninput = updateQuote;
  $$('[data-q]').forEach(b=>{
    b.onclick = async ()=>{
      if(!me){ await connect(); }
      const sym=$("#swapFrom").value;
      let bal = sym==="ETH" ? await web3.getBalance(me) : await USDC.connect(provider).balanceOf(me);
      const dec = sym==="ETH"?18:usdcDecimals;
      const f = parseFloat(b.dataset.q)/100;
      const v = +ethers.utils.formatUnits(bal, dec) * f;
      $("#swapAmount").value = String(v);
      updateQuote();
    };
  });

  // swap action (on-chain)
  $("#btnSwap").onclick = doSwap;

  // vault deposits
  $("#btnDepEth").onclick = async ()=>{
    try{
      if(!me){ await connect(); }
      const amt = parseFloat($("#depEthAmt").value);
      if(!(amt>0)) return toast("Montant ETH invalide");
      const v = ethers.utils.parseEther(String(amt));
      const tx = await vault.connect(signer).depositETH({value:v});
      toast("Dépôt ETH en cours…"); await tx.wait(); toast("Dépôt ETH ✅");
      $("#depEthAmt").value="";
      await refreshTvlAndLb(); await refreshBalances();
    }catch(e){ console.error(e); toast("Échec dépôt ETH"); }
  };

  $("#btnDepUsdc").onclick = async ()=>{
    try{
      if(!me){ await connect(); }
      const amt = parseFloat($("#depUsdcAmt").value);
      if(!(amt>0)) return toast("Montant USDC invalide");
      const a = ethers.utils.parseUnits(String(amt), usdcDecimals);
      const allowance = await USDC.connect(provider).allowance(me, VAULT_ADDRESS);
      if(allowance.lt(a)){
        toast("Approve USDC…"); const txa = await USDC.connect(signer).approve(VAULT_ADDRESS, a); await txa.wait();
      }
      toast("Dépôt USDC en cours…");
      const tx = await vault.connect(signer).depositUSDC(a); await tx.wait(); toast("Dépôt USDC ✅");
      $("#depUsdcAmt").value="";
      await refreshTvlAndLb(); await refreshBalances();
    }catch(e){ console.error(e); toast("Échec dépôt USDC"); }
  };

  // Pools -> ADD (double-sided 50/50)
  $("#btnAddPool").onclick = async ()=>{
    try{
      if(!me){ await connect(); }
      const input = prompt("Montant TOTAL en $ à déposer (50% ETH / 50% USDC) ?");
      if(!input) return;
      const usd = parseFloat(input);
      if(!(usd>0)) return toast("Montant invalide");

      const price8 = await swap.ethUsd(); const price = Number(price8)/1e8;
      const half = usd/2;

      // ETH côté
      const ethAmt = half/price; // en ETH
      const tx1 = await vault.connect(signer).depositETH({ value: ethers.utils.parseEther(String(ethAmt)) });
      toast("Dépôt côté ETH…"); await tx1.wait();

      // USDC côté
      const usdcAmt = ethers.utils.parseUnits(String(half), usdcDecimals); // 1$ = 1 USDC
      const allowance = await USDC.connect(provider).allowance(me, VAULT_ADDRESS);
      if(allowance.lt(usdcAmt)){
        const txa = await USDC.connect(signer).approve(VAULT_ADDRESS, usdcAmt); toast("Approve USDC…"); await txa.wait();
      }
      const tx2 = await vault.connect(signer).depositUSDC(usdcAmt);
      toast("Dépôt côté USDC…"); await tx2.wait();

      toast("Dépôt double-sided 50/50 ✅");
      await refreshTvlAndLb(); await refreshBalances();
    }catch(e){ console.error(e); toast("Échec du dépôt 50/50"); }
  };
}

/* ========= Connexion ========= */
async function connect(silent=false){
  if(!window.ethereum){ toast("Installe MetaMask"); throw new Error("no mm"); }
  web3 = new ethers.providers.Web3Provider(window.ethereum);
  await web3.send("eth_requestAccounts", []);
  signer = web3.getSigner();
  me = await signer.getAddress();
  localStorage.setItem("furia_autoconnect","1");
  $("#btnConnect").textContent = me.slice(0,6)+"…"+me.slice(-4);
  try{ const net = await web3.getNetwork(); $("#netTag").textContent = `Réseau: ${net.name||net.chainId}`; }catch{}
  refreshBalances();
}

/* ========= Quote + Swap ========= */
async function refreshStatic(){
  // prix & fee
  const feeBps = await swap.feeBps();
  $("#feeKpi").textContent = (Number(feeBps)/100).toFixed(2)+"%";
  await refreshTvlAndLb();
  updateQuote();
}

async function updateQuote(){
  try{
    const price8 = await swap.ethUsd();
    const price = Number(price8)/1e8; // USD par ETH
    $("#priceKpi").textContent = "$"+price.toLocaleString();

    const feeBps = Number(await swap.feeBps());
    const fee = feeBps/10_000;

    const from = $("#swapFrom").value, to=$("#swapTo").value;
    let amt = parseFloat($("#swapAmount").value||"0");
    if(!(amt>0)){ $("#youReceive").firstElementChild.textContent="—"; return; }

    let outTxt="—";
    if(from==="ETH" && to==="USDC"){
      const usdc = amt*price*(1-fee);
      outTxt = usdc.toLocaleString(undefined,{maximumFractionDigits:2})+" USDC";
    }else if(from==="USDC" && to==="ETH"){
      const eth = (amt/price)*(1-fee);
      outTxt = eth.toFixed(6)+" ETH";
    }else{
      outTxt = "Paire invalide";
    }
    $("#youReceive").firstElementChild.textContent = outTxt;

    // TVL swap (équiv. ETH)
    const tvlEth = await tvlInEth();
    $("#tvlSwapEth").textContent = tvlEth.toFixed(4)+" ETH";
  }catch(e){ console.warn(e); }
}

async function doSwap(){
  try{
    if(!me){ await connect(); }
    const from=$("#swapFrom").value, to=$("#swapTo").value;
    const amt=parseFloat($("#swapAmount").value);
    if(!(amt>0)) return toast("Montant invalide");

    const s = swap.connect(signer);
    if(from==="ETH" && to==="USDC"){
      const value = ethers.utils.parseEther(String(amt));
      toast("Swap ETH → USDC…");
      const tx = await s.swapETHforUSDC({value});
      await tx.wait();
      toast("Swap réussi ✅");
    }else if(from==="USDC" && to==="ETH"){
      const a = ethers.utils.parseUnits(String(amt), usdcDecimals);
      const allowance = await USDC.connect(provider).allowance(me, SWAP_ADDRESS);
      if(allowance.lt(a)){
        toast("Approve USDC…");
        const txa = await USDC.connect(signer).approve(SWAP_ADDRESS, a); await txa.wait();
      }
      toast("Swap USDC → ETH…");
      const tx = await s.swapUSDCforETH(a); await tx.wait();
      toast("Swap réussi ✅");
    }else{
      return toast("Sélectionne ETH↔USDC");
    }

    await refreshBalances();
    await refreshTvlAndLb();
    updateQuote();
  }catch(e){ console.error(e); toast("Échec du swap"); }
}

/* ========= TVL / Balances ========= */
async function tvlInEth(){
  const [totEth, totUsdc, price8] = await Promise.all([
    vault.totalETH(), vault.totalUSDC(), swap.ethUsd()
  ]);
  const price = Number(price8)/1e8;
  const eth = Number(ethers.utils.formatEther(totEth));
  const usdc = Number(ethers.utils.formatUnits(totUsdc, usdcDecimals));
  return eth + (usdc/price);
}
async function refreshTvlAndLb(){
  const tvlEth = await tvlInEth();
  $("#tvlPools").textContent = tvlEth.toFixed(4)+" ETH";
  $("#rowPoolTvlEth").textContent = tvlEth.toFixed(4)+" ETH";
  await refreshLeaderboard();
}
async function refreshBalances(){
  if(!me) return;
  const [eth, usdc] = await Promise.all([
    web3.getBalance(me),
    USDC.connect(provider).balanceOf(me)
  ]);
  const ethF  = +ethers.utils.formatEther(eth);
  const usdcF = +ethers.utils.formatUnits(usdc, usdcDecimals);
  $("#balanceLine").textContent = `Solde: ${ethF.toFixed(4)} ETH · ${usdcF.toLocaleString(undefined,{maximumFractionDigits:2})} USDC`;
}

/* ========= Leaderboard (pointsOf + scan events) ========= */
async function refreshLeaderboard(){
  try{
    // 1) collect participants récents via events du vault
    const latest = await provider.getBlockNumber();
    const fromBlock = Math.max(0, latest - 300_000); // ~quelques jours
    const filters = [
      vault.filters.DepositETH(null,null),
      vault.filters.DepositUSDC(null,null),
      vault.filters.WithdrawETH(null,null),
      vault.filters.WithdrawUSDC(null,null)
    ];
    const logs = (await Promise.all(filters.map(f=>vault.queryFilter(f, fromBlock, latest)))).flat();
    const set = new Set(logs.map(l=>l.args.user));
    if(me) set.add(me);

    // 2) fetch pointsOf pour chacun
    const arr = await Promise.all([...set].map(async addr=>{
      let p=ethers.BigNumber.from(0);
      try{ p = await vault.pointsOf(addr); }catch{}
      return {addr, pts: p};
    }));
    // 3) tri / affichage
    arr.sort((a,b)=> (b.pts.gt(a.pts)?1:-1));
    const body = $("#lbBody"); body.innerHTML="";
    if(arr.length===0){ body.innerHTML = `<tr><td colspan="3" class="muted">Aucun participant détecté récemment.</td></tr>`; return; }
    arr.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${i===0?"🥇":i+1}</td>
        <td><a href="https://base-sepolia.blockscout.com/address/${r.addr}" target="_blank">${r.addr.slice(0,6)}…${r.addr.slice(-4)}</a></td>
        <td class="right">${ethers.utils.formatUnits(r.pts, 0)}</td>`;
      body.appendChild(tr);
    });
  }catch(e){
    console.error(e);
  }
}
</script>
</body>
</html>
