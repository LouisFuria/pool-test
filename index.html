<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MVP · DEX + Gamification (Base Sepolia)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root{ --bg:#0b0f19; --elev:#0f1524; --card:#11172b; --txt:#e6e9ef; --muted:#94a3b8; --border:#1f2942; --pri:#8b5cf6; --ok:#10b981; --err:#ef4444 }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family:Inter,system-ui; }
    .wrap{ max-width:1100px; margin:24px auto 60px; padding:0 16px; }
    .top{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .brand{ font-family:"Space Grotesk",Inter; font-weight:800; font-size:22px }
    .muted{ color:var(--muted); font-size:12px }
    .btn{ border:1px solid var(--border); background:#fff0; color:var(--txt); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer }
    .btn.pri{ background:var(--pri); color:#000; border-color:#0000 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    nav{ display:flex; gap:8px; background:var(--elev); padding:6px; border:1px solid var(--border); border-radius:12px }
    nav button{ border:0; background:#0000; color:var(--muted); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700 }
    nav button.active{ color:var(--txt); background:#ffffff10 }
    .grid{ display:grid; gap:16px }
    @media(min-width:900px){ .g2{ grid-template-columns:1fr 1fr } .g3{ grid-template-columns: repeat(3,1fr) } }
    .card{ background:linear-gradient(180deg,#ffffff08,#0000),var(--card); border:1px solid var(--border); border-radius:16px }
    .card-h{ padding:12px 16px; border-bottom:1px solid var(--border); text-transform:uppercase; letter-spacing:.1em; color:var(--muted); font-size:12px }
    .card-c{ padding:16px }
    input,select{ width:100%; padding:12px; border-radius:12px; background:var(--elev); border:1px solid var(--border); color:var(--txt); outline:none }
    .row{ display:flex; gap:10px; align-items:center }
    .toasts{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px }
    .toast{ background:var(--elev); border:1px solid var(--border); padding:10px 12px; border-radius:10px; min-width:240px }
    .ok{ border-color:#065f46; background:#065f4628 } .err{ border-color:#7f1d1d; background:#7f1d1d28 }
    table{ width:100%; border-collapse:collapse } th,td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:left } th{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em }
    .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted) }
    .stat{ display:flex; gap:12px; align-items:center; border:1px solid var(--border); background:var(--elev); border-radius:14px; padding:12px 14px }
    .val{ font-weight:800; font-size:22px }
    .small{ font-size:12px; color:var(--muted) }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">HCAT DEX <span class="muted">· Base Sepolia</span></div>
      <div class="muted">MVP: Swap (prix fixe) · Pools · Leaderboard (points live)</div>
    </div>
    <div class="row">
      <span id="net" class="pill">Réseau: —</span>
      <button id="connect" class="btn pri">🔗 Connect</button>
    </div>
  </div>

  <div style="margin:12px 0">
    <nav>
      <button id="tab-swap" class="active">Swap</button>
      <button id="tab-pools">Pools</button>
      <button id="tab-leader">Leaderboard</button>
    </nav>
  </div>

  <!-- SWAP -->
  <section id="swap" class="grid g2">
    <div class="card">
      <div class="card-h">Swap</div>
      <div class="card-c grid">
        <div class="row">
          <select id="fromTok">
            <option value="ETH">ETH</option>
            <option value="USDC">USDC</option>
          </select>
          <button class="btn" id="switchPair">⇄</button>
          <select id="toTok">
            <option value="USDC">USDC</option>
            <option value="ETH">ETH</option>
          </select>
        </div>
        <input id="pay" inputmode="decimal" placeholder="You pay…" />
        <div class="row actions">
          <button class="btn" data-q="25">25%</button>
          <button class="btn" data-q="50">50%</button>
          <button class="btn" data-q="75">75%</button>
          <button class="btn" data-q="100">100%</button>
        </div>
        <div class="stat">
          <div style="flex:1">
            <div class="small">You Receive</div>
            <div class="val" id="receive">—</div>
            <div class="small" id="quote">(prix fixe, slippage négl.)</div>
          </div>
          <button id="swapBtn" class="btn pri">Swap</button>
        </div>
        <div class="small" id="balances">Solde: —</div>
      </div>
    </div>
    <div class="card">
      <div class="card-h">Infos</div>
      <div class="card-c grid">
        <div class="stat"><div style="flex:1">Prix ETH/USD</div><div class="val" id="price">—</div></div>
        <div class="stat"><div style="flex:1">Frais</div><div class="val" id="fees">—</div></div>
        <div class="stat"><div style="flex:1">TVL (Swap)</div><div class="val" id="tvlSwap">—</div></div>
      </div>
    </div>
  </section>

  <!-- POOLS -->
  <section id="pools" style="display:none">
    <div class="grid g3" style="margin-top:12px;">
      <div class="stat" style="grid-column: span 1;"><div style="flex:1">TVL total</div><div class="val" id="tvlAll">—</div></div>
      <div class="stat"><div style="flex:1">Volume 24h</div><div class="val" id="vol24">—</div></div>
      <div class="stat"><div style="flex:1">Fees 24h</div><div class="val" id="fee24">—</div></div>
    </div>
    <div class="card" style="margin-top:16px;">
      <div class="card-h">Pools</div>
      <div class="card-c">
        <table>
          <thead><tr><th>Pair</th><th>Fee</th><th>TVL</th><th>Vol(24h)</th><th>Fees(24h)</th><th>APR(24h)</th></tr></thead>
          <tbody id="poolsBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="leader" style="display:none">
    <div class="card">
      <div class="card-h">Mon profil</div>
      <div class="card-c grid g3">
        <div class="stat"><div style="flex:1">Mes points</div><div class="val" id="myPts">—</div></div>
        <div class="stat"><div style="flex:1">Mon rang</div><div class="val" id="myRank">—</div></div>
        <div class="stat"><div style="flex:1">Adresse</div><div class="val" id="meAddr">—</div></div>
      </div>
    </div>
    <div class="card" style="margin-top:16px;">
      <div class="card-h">Leaderboard</div>
      <div class="card-c">
        <table>
          <thead><tr><th>#</th><th>Adresse</th><th>Points</th></tr></thead>
        </table>
        <table>
          <tbody id="lbBody"></tbody>
        </table>
        <div class="small">Classement basé sur points live (1 pt/min/$). Sources : logs du vault (participants récents).</div>
      </div>
    </div>
  </section>
</div>

<div class="toasts" id="toasts"></div>

<script>
(async () => {
  // ====== ADRESSES (Base Sepolia)
  const USDC_ADDRESS = "0x3F532813FEB32E1990d9c7Ca8Cb29b62C573512B";
  const POOL_ADDRESS = "0x1720e9ef567d1f29076EcE7E47CBc5F12F52F335"; // DualTokenVaultWithPoints
  const SWAP_ADDRESS = "0x9965B8ef813E6247c6788AF7836756a579474484"; // <-- 🟣 mets l'adresse du contrat FixedPriceSwap

  // ====== ABIs
  const ERC20_ABI = [
    {"type":"function","name":"decimals","stateMutability":"view","inputs":[],"outputs":[{"type":"uint8"}]},
    {"type":"function","name":"balanceOf","stateMutability":"view","inputs":[{"name":"o","type":"address"}],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"allowance","stateMutability":"view","inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"approve","stateMutability":"nonpayable","inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[{"type":"bool"}]},
    {"type":"function","name":"transferFrom","stateMutability":"nonpayable","inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[{"type":"bool"}]}
  ];
  const VAULT_ABI = [
    {"type":"function","name":"totalETH","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"totalUSDC","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"userETH","stateMutability":"view","inputs":[{"name":"u","type":"address"}],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"userUSDC","stateMutability":"view","inputs":[{"name":"u","type":"address"}],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"pendingPointsScaled","stateMutability":"view","inputs":[{"name":"u","type":"address"}],"outputs":[{"type":"uint256"}]}
  ];
  const SWAP_ABI = [
    {"type":"function","name":"ethUsd","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"feeBps","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"tvl","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"},{"type":"uint256"}]},
    {"type":"function","name":"setEthUsd","stateMutability":"nonpayable","inputs":[{"name":"_price8","type":"uint256"}],"outputs":[]},
    {"type":"function","name":"swapETHForUSDC","stateMutability":"payable","inputs":[],"outputs":[]},
    {"type":"function","name":"swapUSDCForETH","stateMutability":"nonpayable","inputs":[{"name":"usdcIn","type":"uint256"}],"outputs":[]},
    // Events (pour volume/fees)
    {"type":"event","name":"SwapETHForUSDC","inputs":[
      {"name":"user","type":"address","indexed":true},
      {"name":"ethIn","type":"uint256","indexed":false},
      {"name":"usdcOut","type":"uint256","indexed":false},
      {"name":"price8","type":"uint256","indexed":false},
      {"name":"feeBps","type":"uint256","indexed":false}
    ],"anonymous":false},
    {"type":"event","name":"SwapUSDCForETH","inputs":[
      {"name":"user","type":"address","indexed":true},
      {"name":"usdcIn","type":"uint256","indexed":false},
      {"name":"ethOut","type":"uint256","indexed":false},
      {"name":"price8","type":"uint256","indexed":false},
      {"name":"feeBps","type":"uint256","indexed":false}
    ],"anonymous":false}
  ];

  // ====== Boilerplate
  const $ = (id)=>document.getElementById(id);
  const toastBox = $("toasts");
  function toast(msg, type="ok"){ const d=document.createElement("div"); d.className=`toast ${type}`; d.textContent=msg; toastBox.appendChild(d); setTimeout(()=>d.remove(),3000); }

  // Tabs
  const tabs = { swap:$("swap"), pools:$("pools"), leader:$("leader") };
  function showTab(k){
    for(const t of ["swap","pools","leader"]) tabs[t].style.display = (t===k)?"block":"none";
    for(const id of ["tab-swap","tab-pools","tab-leader"]) $(id).classList.remove("active");
    $("tab-"+k).classList.add("active");
  }
  $("tab-swap").onclick = ()=> showTab("swap");
  $("tab-pools").onclick = ()=> showTab("pools");
  $("tab-leader").onclick = ()=> showTab("leader");

  // Wallet
  let provider=null, signer=null, me=null, usdcDec=6;
  if(!window.ethereum){ toast("Installe MetaMask", "err"); }
  else provider = new ethers.providers.Web3Provider(window.ethereum);

  async function connect(){
    await window.ethereum.request({ method:"eth_requestAccounts" });
    signer = provider.getSigner();
    me = await signer.getAddress();
    $("connect").textContent = "✅ "+me.slice(0,6)+"…"+me.slice(-4);
    updateNet();
    await initContracts();
    await refreshAll();
  }
  $("connect").onclick = connect;

  async function updateNet(){
    const net = await provider.getNetwork();
    $("net").textContent = `Réseau: ${Number(net.chainId)===84532 ? "Base Sepolia ✅" : net.name+"("+net.chainId+")"}`;
    if(Number(net.chainId)!==84532){
      try{
        await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:"0x14A74"}] });
      }catch(e){}
    }
  }

  // Contracts
  let usdcRO, usdcRW, vaultRO, swapRO, swapRW;
  async function initContracts(){
    usdcRO = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, provider);
    vaultRO = new ethers.Contract(POOL_ADDRESS, VAULT_ABI, provider);
    swapRO  = new ethers.Contract(SWAP_ADDRESS, SWAP_ABI, provider);
    if(signer){ usdcRW = usdcRO.connect(signer); swapRW = swapRO.connect(signer); }
    try{ usdcDec = await usdcRO.decimals(); }catch{}
  }

  // ====== SWAP UI
  const fromSel = $("fromTok"), toSel = $("toTok"), payIn = $("pay"), recvEl = $("receive");
  $("switchPair").onclick = ()=>{
    const a=fromSel.value, b=toSel.value; fromSel.value=b; toSel.value=a; computeQuote();
  };
  payIn.oninput = computeQuote;
  document.querySelectorAll('[data-q]').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!me){ toast("Connecte ton wallet", "err"); return; }
      const pct = Number(btn.dataset.q);
      const from = fromSel.value;
      if(from==="ETH"){
        const bal = await provider.getBalance(me);
        payIn.value = (Number(ethers.utils.formatEther(bal))*pct/100).toString();
      }else{
        const bal = await usdcRO.balanceOf(me);
        payIn.value = ethers.utils.formatUnits(bal, usdcDec) * pct/100;
      }
      computeQuote();
    };
  });

  async function readPriceFeeTVL(){
    try{
      const [p8,f, tvlT] = await Promise.all([ swapRO.ethUsd(), swapRO.feeBps(), swapRO.tvl() ]);
      const price = Number(ethers.utils.formatUnits(p8,8));
      $("price").textContent = price ? `$${price.toLocaleString()}` : "—";
      $("fees").textContent = (Number(f)/100).toFixed(2)+"%";
      const [ethBal, usdcBal] = tvlT;
      $("tvlSwap").textContent = `${Number(ethers.utils.formatEther(ethBal)).toFixed(4)} ETH + ${Number(ethers.utils.formatUnits(usdcBal,6)).toLocaleString()} USDC`;
      return { price, feeBps:Number(f), ethBal, usdcBal };
    }catch(e){ console.error(e); return {price:0,feeBps:0}; }
  }

  async function computeQuote(){
    const { price, feeBps } = await readPriceFeeTVL();
    const from = fromSel.value, to = toSel.value;
    const amt = Number((payIn.value||"0").trim()); if(!amt||!price){ recvEl.textContent="—"; return; }
    if(from==="ETH" && to==="USDC"){
      const gross = amt*price;
      const fee = gross*feeBps/10000;
      recvEl.textContent = (gross - fee).toLocaleString(undefined,{maximumFractionDigits:2})+" USDC";
    }else if(from==="USDC" && to==="ETH"){
      const fee = amt*feeBps/10000;
      const net = amt - fee;
      const eth = net/price;
      recvEl.textContent = eth.toFixed(6)+" ETH";
    }else{
      recvEl.textContent = "—";
    }
    // balances
    if(me){
      const [ethB, usdcB] = await Promise.all([ provider.getBalance(me), usdcRO.balanceOf(me) ]);
      $("balances").textContent = `Solde: ${Number(ethers.utils.formatEther(ethB)).toFixed(4)} ETH · ${Number(ethers.utils.formatUnits(usdcB,usdcDec)).toFixed(2)} USDC`;
    }
  }

  $("swapBtn").onclick = async ()=>{
    if(!me) return toast("Connecte ton wallet", "err");
    const { price } = await readPriceFeeTVL();
    const from = fromSel.value, to = toSel.value;
    const amtStr = (payIn.value||"0").trim(); const amt = Number(amtStr);
    if(!amt || amt<=0) return;
    try{
      if(from==="ETH" && to==="USDC"){
        const tx = await swapRW.swapETHForUSDC({ value: ethers.utils.parseEther(amtStr) });
        await tx.wait(); toast("✅ Swap ETH→USDC confirmé");
      }else if(from==="USDC" && to==="ETH"){
        const amount = ethers.utils.parseUnits(amtStr, usdcDec);
        const allowance = await usdcRO.allowance(me, SWAP_ADDRESS);
        if(allowance.lt(amount)){ const a=await usdcRW.approve(SWAP_ADDRESS, amount); await a.wait(); }
        const tx = await swapRW.swapUSDCForETH(amount); await tx.wait(); toast("✅ Swap USDC→ETH confirmé");
      }else{
        return toast("Pair invalide", "err");
      }
      payIn.value = ""; recvEl.textContent="—";
      await refreshAll();
    }catch(e){ console.error(e); toast("❌ Échec du swap", "err"); }
  };

  // ====== POOLS (stats & liste)
  // On n'a qu'une pool (ETH/USDC fixe) pour le MVP
  async function refreshPools(){
    const { price, feeBps, ethBal, usdcBal } = await readPriceFeeTVL();
    const tvlUsd = Number(ethers.utils.formatEther(ethBal))*price + Number(ethers.utils.formatUnits(usdcBal,6));
    // Vol & fees 24h: on scanne les events des 10^5 derniers blocs (~qq jours sur Sepolia)
    let vol24=0, fees24=0;
    try{
      const current = await provider.getBlockNumber();
      const fromBlock = Math.max(0, current - 100000);
      const toBlock = current;
      // SwapETHForUSDC
      const topic1 = ethers.utils.id("SwapETHForUSDC(address,uint256,uint256,uint256,uint256)");
      const logs1 = await provider.getLogs({ fromBlock, toBlock, address: SWAP_ADDRESS, topics:[topic1] });
      for(const l of logs1){
        const i = new ethers.utils.Interface(SWAP_ABI);
        const ev = i.parseLog(l);
        const usdcOut = Number(ethers.utils.formatUnits(ev.args.usdcOut,6));
        const fee = usdcOut * feeBps / (10000 - feeBps); // approx fee in usdc
        vol24 += usdcOut;
        fees24 += fee;
      }
      // SwapUSDCForETH
      const topic2 = ethers.utils.id("SwapUSDCForETH(address,uint256,uint256,uint256,uint256)");
      const logs2 = await provider.getLogs({ fromBlock, toBlock, address: SWAP_ADDRESS, topics:[topic2] });
      for(const l of logs2){
        const i = new ethers.utils.Interface(SWAP_ABI);
        const ev = i.parseLog(l);
        const usdcIn = Number(ethers.utils.formatUnits(ev.args.usdcIn,6));
        const fee = usdcIn * feeBps / 10000;
        vol24 += usdcIn;
        fees24 += fee;
      }
    }catch(e){ console.error(e); }

    $("tvlAll").textContent = "$"+tvlUsd.toLocaleString(undefined,{maximumFractionDigits:2});
    $("vol24").textContent = "$"+vol24.toLocaleString(undefined,{maximumFractionDigits:2});
    $("fee24").textContent = "$"+fees24.toLocaleString(undefined,{maximumFractionDigits:2});

    // Table pools
    const apr = tvlUsd>0 ? (fees24*365/tvlUsd*100) : 0;
    $("poolsBody").innerHTML = `
      <tr>
        <td>ETH / USDC (Fixed)</td>
        <td>${(await swapRO.feeBps())/100}%</td>
        <td>$${tvlUsd.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${vol24.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${fees24.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>${isFinite(apr)?apr.toFixed(2):"0.00"}%</td>
      </tr>
    `;
  }

  // ====== LEADERBOARD (points vault)
  async function refreshLeaderboard(){
    $("meAddr").textContent = me ? me.slice(0,6)+"…"+me.slice(-4) : "—";
    // 1) Récupérer les participants récents via logs du vault (Deposit/Withdraw)
    const current = await provider.getBlockNumber();
    const fromBlock = Math.max(0, current - 200000); // ~quelques semaines
    const topics = [
      // keccak DepositETH/USDC/Withdraw... du vault with points
      ethers.utils.id("DepositETH(address,uint256)"),
      ethers.utils.id("DepositUSDC(address,uint256)"),
      ethers.utils.id("WithdrawETH(address,uint256)"),
      ethers.utils.id("WithdrawUSDC(address,uint256)")
    ];
    const addrsSet = new Set();
    for(const t of topics){
      try{
        const logs = await provider.getLogs({ fromBlock, toBlock: current, address: POOL_ADDRESS, topics:[t] });
        for(const l of logs){ addrsSet.add("0x"+l.topics[1].slice(26)); } // indexed user
      }catch(e){}
    }
    const addrs = Array.from(addrsSet).slice(0,200); // limite
    // 2) Lire les points
    const vault = new ethers.Contract(POOL_ADDRESS, VAULT_ABI, provider);
    const rows = [];
    for(const a of addrs){
      try{
        const ptsScaled = await vault.pendingPointsScaled(a);
        const pts = Number(ethers.utils.formatUnits(ptsScaled,6));
        rows.push({a, pts});
      }catch(e){}
    }
    rows.sort((x,y)=> y.pts - x.pts);
    // 3) Afficher & mon rang
    const body = $("lbBody"); body.innerHTML = "";
    rows.forEach((r,i)=>{
      const tr = document.createElement("tr");
      const medal = i===0?"🥇":i===1?"🥈":i===2?"🥉":(i+1);
      tr.innerHTML = `<td>${medal}</td><td><a href="https://sepolia.basescan.org/address/${r.a}" target="_blank" style="color:#fff">${r.a.slice(0,6)}…${r.a.slice(-4)}</a></td><td>${r.pts.toLocaleString(undefined,{maximumFractionDigits:2})}</td>`;
      body.appendChild(tr);
    });
    if(me){
      const mine = rows.findIndex(r=> r.a.toLowerCase()===me.toLowerCase());
      $("myRank").textContent = mine>=0 ? (mine+1) : "—";
      try{
        const minePts = await vault.pendingPointsScaled(me);
        $("myPts").textContent = Number(ethers.utils.formatUnits(minePts,6)).toLocaleString(undefined,{maximumFractionDigits:2});
      }catch(e){ $("myPts").textContent = "—"; }
    }
  }

  // ====== Refresh global
  async function refreshAll(){
    await computeQuote();
    await refreshPools();
    await refreshLeaderboard();
  }

  // init
  await updateNet();
  await initContracts();
  await refreshAll();

  if(window.ethereum){
    window.ethereum.on?.("accountsChanged", ()=> location.reload());
    window.ethereum.on?.("chainChanged", ()=> location.reload());
  }
})();
</script>
</body>
</html>
