<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FURIA DEX · Base Sepolia</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root{
    --bg:#0c0f16;--panel:#121725;--muted:#7f8aa3;--text:#e7ecf7;--primary:#7a57ff;--primary-2:#a594ff;--ok:#22c55e;--err:#ef4444;
    --card:#101522;--chip:#0f1422;--soft:#141a2a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,segoe ui,Roboto,"Helvetica Neue",Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  .top{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .brand{font-weight:800;font-size:28px;letter-spacing:.5px}
  .crumb{color:var(--muted);font-size:14px}
  .tabs{display:flex;gap:10px;margin:16px 0}
  .tab{padding:10px 16px;border-radius:12px;background:var(--soft);cursor:pointer;color:var(--muted);border:1px solid #1b2235}
  .tab.active{color:#fff;background:var(--panel);box-shadow:0 0 0 1px #1f2840 inset}
  .right{margin-left:auto;display:flex;gap:10px;align-items:center}
  .chip{background:#0f1628;padding:8px 12px;border-radius:999px;color:#cbd5e1;border:1px solid #1b2235;font-size:13px}
  .btn{background:var(--primary);color:white;padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
  .btn.secondary{background:#1b2235;color:#e2e8f0}
  .btn.ghost{background:transparent;border:1px solid #1b2235;color:#cbd5e1}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .grid{display:grid;gap:16px}
  @media (min-width:980px){.grid-2{grid-template-columns:1.15fr .85fr}}
  .card{background:var(--panel);border:1px solid #1b2235;border-radius:16px;padding:18px}
  .h{font-size:14px;letter-spacing:.12em;color:#9fb0d6;text-transform:uppercase;margin-bottom:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .input, select{width:100%;padding:14px 14px;border-radius:12px;background:#0f1422;color:#e5edff;border:1px solid #1b2235;font-size:16px;outline:none}
  select {appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 20 20" fill="%23a6b2d6"><path d="M5.5 7.5l4.5 5 4.5-5"/></svg>');background-repeat:no-repeat;background-position:right 10px center;padding-right:36px}
  .pill{padding:8px 12px;border-radius:999px;background:#0f1422;border:1px solid #1b2235;color:#c9d5f2;cursor:pointer}
  .pill.active{background:#1b2235}
  .stat{background:#0e1320;border:1px solid #1b2235;border-radius:16px;padding:16px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .big{font-size:28px}
  .swap-ctrls{display:grid;grid-template-columns:1fr 58px 1fr;gap:10px}
  .swap-arrows{display:flex;align-items:center;justify-content:center}
  .swap-arrows .pill{margin-left:-4px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:14px;border-bottom:1px solid #1b2235;text-align:left}
  .badge{font-weight:800;color:#fff;background:var(--primary);padding:2px 8px;border-radius:8px}
  .note{color:#a7b3d5;font-size:13px;margin-top:8px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0f1422;border:1px solid #1b2235;color:#e8eeff;padding:12px 14px;border-radius:12px;box-shadow:0 4px 28px rgba(0,0,0,.35)}
  dialog{border:none;border-radius:16px;padding:0;max-width:560px;width:92%;background:var(--panel);color:var(--text)}
  dialog .body{padding:18px}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .green{color:var(--ok)} .red{color:var(--err)}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background:#0f1422;border:1px solid #1b2235;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">FURIA DEX</div>
    <div class="crumb">· Base Sepolia</div>
    <div class="right">
      <div id="netChip" class="chip">Réseau: —</div>
      <div id="addrChip" class="chip" title="Cliquer pour copier" style="display:none;cursor:copy">—</div>
      <button id="btnImportUSDC" class="btn ghost" title="Ajouter USDC à votre wallet">+ USDC</button>
      <button id="btnDisconnect" class="btn secondary" style="display:none">Disconnect</button>
      <button id="btnConnect" class="btn">Connect</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="swap">Swap</div>
    <div class="tab" data-tab="pools">Pools</div>
    <div class="tab" data-tab="vaults">Vaults</div>
    <div class="tab" data-tab="leaderboard">Leaderboard</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- SWAP -->
  <section id="swap" class="grid grid-2">
    <div class="card">
      <div class="h">Swap ETH ↔ USDC · Règle points: <b>10 pts / $ swappé</b></div>
      <div class="swap-ctrls">
        <select id="swapFrom">
          <option value="ETH">ETH</option>
          <option value="USDC">USDC</option>
        </select>
        <div class="swap-arrows"><button id="btnFlip" class="pill" title="Inverser">⇄</button></div>
        <select id="swapTo">
          <option value="USDC">USDC</option>
          <option value="ETH">ETH</option>
        </select>
      </div>
      <div style="margin-top:10px" class="three">
        <input id="swapAmount" class="input" placeholder="Montant" inputmode="decimal" />
        <input id="slippage" class="input" placeholder="Slippage % (affichage)" value="0.5" />
        <div class="row" style="gap:8px">
          <button class="pill pct" data-p="25">25%</button>
          <button class="pill pct" data-p="50">50%</button>
          <button class="pill pct" data-p="75">75%</button>
          <button class="pill pct" data-p="100">100%</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px;background:#0f1422">
        <div class="muted">You Receive</div>
        <div id="youReceive" class="big">—</div>
        <div id="minOutBox" class="note">Min. reçu (slippage): —</div>
        <div id="gasBox" class="note">Estimation gas: —</div>
        <div id="impactBox" class="note">Impact prix: 0% (prix fixe)</div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:space-between">
        <div>
          <div id="balances" class="muted">Solde: —</div>
          <div id="allowBox" class="note">Allowance USDC → Swap: —</div>
        </div>
        <div class="row">
          <button id="btnApproveMax" class="btn ghost" title="Approve un allowance élevé pour éviter les multiples approvals">Approve Max</button>
          <button id="btnSwap" class="btn">Swap</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="h">Infos (Swap)</div>
      <div class="stat"><span>Prix ETH/USD</span><span id="priceBox" class="big">$—</span></div>
      <div class="stat" style="margin-top:10px"><span>Frais</span><span id="feeBox" class="big">—</span></div>
      <div class="stat" style="margin-top:10px"><span>TVL (équiv. ETH)</span><span id="tvlSwap" class="big">—</span></div>
      <div class="note">App appuie sur <span class="kbd">Enter</span> pour lancer le swap.</div>
    </div>
  </section>

  <!-- POOLS -->
  <section id="pools" style="display:none">
    <div class="grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat"><span>TVL (équiv. ETH)</span><span id="tvlPools" class="big">—</span></div>
      <div class="stat"><span>Volume ~24h</span><span id="volPools" class="big">$0</span></div>
      <div class="stat"><span>Mes points (swap)</span><span id="mySwapPts" class="big">0</span></div>
    </div>
    <div class="card" style="margin-top:14px">
      <div class="h">Pools (points: <b>1 pt / $ / min</b>)</div>
      <table class="table">
        <thead><tr>
          <th>Pair</th><th>APY</th><th>TVL (ETH)</th><th>Vol(~24h)</th><th>Points règle</th><th></th>
        </tr></thead>
        <tbody id="poolRows"></tbody>
      </table>
      <div class="note">⚠️ Le dépôt “Pools” utilise le <b>même</b> contrat que le Vault. Ici, l’ADD réalise automatiquement un dépôt <b>50/50</b> (en $) dans le vault.</div>
    </div>
  </section>

  <!-- VAULTS -->
  <section id="vaults" style="display:none">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="h">Vault ETH</div>
        <div class="big" id="vaultEthApy">25%</div>
        <div class="note">Règle points: <b>1 pt / $ / min</b> · refresh 10s</div>
        <div class="two" style="margin-top:10px">
          <input id="vaultEthAmount" class="input" placeholder="Montant ETH (ex: 0.1)"/>
          <div class="row"><button id="btnVaultMaxETH" class="pill">Max</button><button id="btnVaultDepositETH" class="btn">Déposer</button></div>
        </div>
        <div class="note" id="noteVaultETH">(Votre solde et gas seront affichés.)</div>
      </div>
      <div class="card">
        <div class="h">Vault USDC</div>
        <div class="big" id="vaultUsdcApy">25%</div>
        <div class="note">Règle points: <b>1 pt / $ / min</b> · refresh 10s</div>
        <div class="two" style="margin-top:10px">
          <input id="vaultUsdcAmount" class="input" placeholder="Montant USDC (ex: 200)"/>
          <div class="row"><button id="btnVaultMaxUSDC" class="pill">Max</button><button id="btnVaultDepositUSDC" class="btn">Déposer</button></div>
        </div>
        <div class="note" id="noteVaultUSDC">Allowance et gas estimé seront affichés.</div>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="leaderboard" style="display:none">
    <div class="card">
      <div class="h">Leaderboard (vault points)</div>
      <table class="table">
        <thead><tr><th>#</th><th>Adresse</th><th>Points</th></tr></thead>
        <tbody id="lbRows"></tbody>
      </table>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="btnExportCSV" class="btn ghost">Exporter CSV</button>
        <button id="btnRefreshLB" class="btn secondary">Refresh</button>
      </div>
      <div class="note">Règle: <b>1 pt / $ / min</b> (lecture on-chain via <code>pointsOf</code>, refresh 10s).</div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" style="display:none">
    <div class="card">
      <div class="h">Paramètres</div>
      <div class="two">
        <div>
          <label class="muted">Slippage par défaut (%)</label>
          <input id="cfgSlippage" class="input" placeholder="0.5" />
        </div>
        <div>
          <label class="muted">Approve Max montant USDC (ex: 1e12)</label>
          <input id="cfgApproveMax" class="input" placeholder="1000000000000" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button id="btnSaveCfg" class="btn">Sauver</button>
      </div>
      <div class="note">Ces paramètres sont stockés localement dans votre navigateur.</div>
    </div>
  </section>
</div>

<!-- MODAL POOL ADD (double-sided) -->
<dialog id="dlgAdd">
  <div class="body">
    <div class="h">Déposer dans la pool</div>
    <div class="note" style="margin-bottom:8px">Entrer un <b>montant total en $</b>. Le dépôt sera réalisé 50% en ETH et 50% en USDC au prix courant.</div>
    <div class="two">
      <input id="addUsd" class="input" placeholder="Montant en $ (ex: 100)"/>
      <button id="btnAddConfirm" class="btn">Déposer</button>
    </div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="btnAddCancel" class="btn secondary">Annuler</button>
    </div>
  </div>
</dialog>

<div id="toast" class="toast" style="display:none"></div>

<script>
(async function(){
  // ========= CONFIG
  const CHAIN_ID_DEC = 84532;             // Base Sepolia
  const CHAIN_ID_HEX = '0x14A54';
  const SWAP_ADDRESS  = '0x9965B8ef813E6247c6788AF7836756a579474484'; // FixedPriceSwap
  const VAULT_ADDRESS = '0xfC39B74a0c3AD291f88224ec620410c32f3659e4'; // DualTokenVaultWithPoints
  const USDC_ADDRESS  = '0x3F532813FEB32E1990d9c7Ca8Cb29b62C573512B'; // USDCMock
  const APY_POOL = 20;   // affichage
  const APY_VAULT = 25;  // affichage

  // ========= ABIs
  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address owner,address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)"
  ];

  const SWAP_ABI = [
    "function ethUsd() view returns (uint256)",   // 8 déc
    "function feeBps() view returns (uint256)",   // e.g. 30
    "function USDC() view returns (address)",
    "function swapETHforUSDC() payable",
    "function swapUSDCforETH(uint256 usdcIn)",
    "event SwapETHforUSDC(address indexed user, uint256 ethIn, uint256 usdcOut, uint256 price8, uint256 feeBps)",
    "event SwapUSDCforETH(address indexed user, uint256 usdcIn, uint256 ethOut, uint256 price8, uint256 feeBps)"
  ];

  const VAULT_ABI = [
    "function totalETH() view returns (uint256)",
    "function totalUSDC() view returns (uint256)",
    "function depositETH() payable",
    "function depositUSDC(uint256 amount)",
    "function pointsOf(address u) view returns (uint256)",   // points * 1e6 (scaled)
    "event DepositETH(address indexed user, uint256 amount)",
    "event DepositUSDC(address indexed user, uint256 amount)",
    "event WithdrawETH(address indexed user, uint256 amount)",
    "event WithdrawUSDC(address indexed user, uint256 amount)"
  ];

  // ========= Ethers & state
  let provider, signer, me, price8=0, feeBps=0, usdcDecimals=6;
  let swap, vault, usdc;

  // ========= UI helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function toast(t){ const el=$("#toast"); el.textContent=t; el.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display='none',2600); }
  function fmtUsd(n){ return '$'+ Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function fmt(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:6}); }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k,d){ try{const v=JSON.parse(localStorage.getItem(k)); return (v===null||v===undefined)?d:v;}catch{return d;} }

  // ========= Wallet connect / persist / events
  async function ensureProvider(){
    if(!window.ethereum){ toast('Installe MetaMask.'); throw new Error('no wallet'); }
    provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
    const net = await provider.getNetwork();
    $("#netChip").textContent = `Réseau: ${net.name || net.chainId}`;
    if (net.chainId !== CHAIN_ID_DEC){
      try{
        await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: CHAIN_ID_HEX }] });
      }catch(e){ toast('Change de réseau sur Base Sepolia.'); throw e; }
    }
    const a = (await provider.listAccounts())[0];
    if(a){ signer = provider.getSigner(); me = a; }
  }
  async function connect(){
    await ensureProvider();
    const accs = await window.ethereum.request({ method:'eth_requestAccounts' });
    me = accs[0]; signer = provider.getSigner();
    save('furia_connected', true);
    afterConnectUI();
    await onReady();
  }
  function afterConnectUI(){
    if(!me){return}
    $("#btnConnect").style.display='none';
    $("#btnDisconnect").style.display='inline-block';
    $("#addrChip").style.display='inline-block';
    $("#addrChip").textContent = me.slice(0,6)+'…'+me.slice(-4);
    $("#addrChip").onclick = async ()=>{ await navigator.clipboard.writeText(me); toast('Adresse copiée'); };
  }
  function disconnect(){
    me = undefined; signer = undefined;
    save('furia_connected', false);
    $("#btnConnect").style.display='inline-block';
    $("#btnDisconnect").style.display='none';
    $("#addrChip").style.display='none';
    $("#balances").textContent = 'Solde: —';
    $("#allowBox").textContent = 'Allowance USDC → Swap: —';
  }
  $("#btnConnect").onclick = connect;
  $("#btnDisconnect").onclick = disconnect;

  // auto-reconnect
  if(load('furia_connected', false)) {
    ensureProvider().then(async()=>{ 
      const accs = await provider.listAccounts();
      if(accs[0]){ me = accs[0]; signer=provider.getSigner(); afterConnectUI(); onReady(); }
    }).catch(()=>{});
  }

  // wallet events
  if(window.ethereum){
    window.ethereum.on?.('accountsChanged', (accs)=>{ if(accs && accs[0]){ me=accs[0]; signer=provider.getSigner(); afterConnectUI(); onReady(); } else { disconnect(); }});
    window.ethereum.on?.('chainChanged', ()=>{ window.location.reload(); });
  }

  // ========= Contracts init
  async function initContracts(){
    const base = signer ?? provider;
    swap = new ethers.Contract(SWAP_ADDRESS, SWAP_ABI, base);
    vault= new ethers.Contract(VAULT_ADDRESS,VAULT_ABI, base);
    const usdcAddr = USDC_ADDRESS || await swap.USDC().catch(()=>USDC_ADDRESS);
    usdc = new ethers.Contract(usdcAddr, ERC20_ABI, base);
    usdcDecimals = await usdc.decimals().catch(()=>6);
    price8 = (await swap.ethUsd()).toString();
    feeBps = (await swap.feeBps()).toString();
    $("#priceBox").textContent = '$'+(Number(price8)/1e8).toLocaleString();
    $("#feeBox").textContent   = (Number(feeBps)/100).toFixed(2)+'%';
  }

  // ========= Math helpers
  function usdToEth(usd){ return usd / (Number(price8)/1e8); }
  function ethToUsd(eth){ return eth * (Number(price8)/1e8); }
  function applyFee(x){ return x * (1 - Number(feeBps)/10000); }

  // ========= Balances & TVL
  async function refreshBalances(){
    if(!provider) return;
    const p = signer ?? provider;
    const addr = me || (await p.listAccounts())[0];
    if(!addr){ $("#balances").textContent='Solde: —'; return; }
    const ethBal = await provider.getBalance(addr);
    const usdcBal= await usdc.balanceOf(addr);
    $("#balances").textContent = `Solde: ${fmt(ethers.utils.formatEther(ethBal))} ETH · ${fmt(Number(usdcBal)/10**usdcDecimals)} USDC`;
  }
  async function refreshTvl(){
    const tEth  = Number(ethers.utils.formatEther(await vault.totalETH()));
    const tUsdc = Number((await vault.totalUSDC()).toString())/10**usdcDecimals;
    const tvlEthEq = tEth + usdToEth(tUsdc);
    $("#tvlSwap").textContent  = fmt(tvlEthEq)+' ETH';
    $("#tvlPools").textContent = fmt(tvlEthEq)+' ETH';
    // pool row fill
    const row = `
      <tr>
        <td>ETH / USDC</td>
        <td>${APY_POOL}%</td>
        <td>${fmt(tvlEthEq)}</td>
        <td>$0</td>
        <td>1 pt / $ / min</td>
        <td><button class=\"btn\" id=\"btnOpenAdd\">ADD</button></td>
      </tr>`;
    $("#poolRows").innerHTML = row;
    const btn = $("#btnOpenAdd"); if(btn) btn.onclick = ()=>$("#dlgAdd").showModal();
  }

  // ========= Quote & UI calc
  function currentSlippage(){
    const v = parseFloat($("#slippage").value || load('cfg_slippage', '0.5'));
    return isFinite(v) && v>=0 ? v : 0.5;
  }
  async function updateAllowanceBox(){
    try{
      if(!me){ $("#allowBox").textContent = 'Allowance USDC → Swap: —'; return; }
      const a = await usdc.allowance(me, SWAP_ADDRESS);
      $("#allowBox").textContent = `Allowance USDC → Swap: ${fmt(Number(a)/10**usdcDecimals)}`;
    }catch{}
  }
  async function estimateGasAndShow(txPromise){
    try{
      const gas = await txPromise;
      const gPrice = await provider.getGasPrice();
      const costEth = Number(ethers.utils.formatEther(gas.mul(gPrice)));
      $("#gasBox").textContent = `Estimation gas: ${fmt(costEth)} ETH (~${fmtUsd(ethToUsd(costEth))})`;
    }catch{ $("#gasBox").textContent = 'Estimation gas: —'; }
  }
  function updateQuote(){
    const from = $("#swapFrom").value, to=$("#swapTo").value;
    let amt = parseFloat($("#swapAmount").value);
    if(!isFinite(amt) || amt<=0){ $("#youReceive").textContent='—'; $("#minOutBox").textContent='Min. reçu (slippage): —'; return; }
    let out=0; const price = Number(price8)/1e8;
    if(from==='ETH' && to==='USDC'){ out = applyFee(amt*price); $("#youReceive").textContent = fmt(out)+' USDC'; }
    else if(from==='USDC' && to==='ETH'){ out = applyFee(amt/price); $("#youReceive").textContent = fmt(out)+' ETH'; }
    else { $("#youReceive").textContent='—'; }
    const slip = currentSlippage();
    const minOut = out * (1 - slip/100);
    $("#minOutBox").textContent = `Min. reçu (slippage ${slip}%): ${fmt(minOut)} ${to}`;
  }
  $("#swapAmount").oninput = updateQuote;
  $("#slippage").oninput = updateQuote;
  $("#swapFrom").onchange = ()=>{ if($("#swapFrom").value===$("#swapTo").value){ $("#swapTo").value = $("#swapFrom").value==='ETH'?'USDC':'ETH'; } updateQuote();};
  $("#swapTo").onchange   = updateQuote;
  $("#btnFlip").onclick   = ()=>{ const a=$("#swapFrom").value; $("#swapFrom").value=$("#swapTo").value; $("#swapTo").value=a; updateQuote(); };
  $$(".pct").forEach(b=>b.onclick=async()=>{
    if(!me){ toast('Connecte ton wallet'); return;}
    const from = $("#swapFrom").value;
    if(from==='ETH'){
      const bal = await provider.getBalance(me);
      const val = Number(ethers.utils.formatEther(bal)) * (Number(b.dataset.p)/100);
      $("#swapAmount").value = (Math.max(0,val-0.0002)).toFixed(6);
    }else{
      const bal = await usdc.balanceOf(me);
      const val = (Number(bal)/10**usdcDecimals) * (Number(b.dataset.p)/100);
      $("#swapAmount").value = val.toFixed(2);
    }
    updateQuote();
  });

  // ========= Pools: dépôt double-sided 50/50 ($)
  $("#btnAddCancel").onclick = ()=>$("#dlgAdd").close();
  $("#btnAddConfirm").onclick = async ()=>{
    try{
      if(!me){ await connect(); }
      const usd = parseFloat($("#addUsd").value);
      if(!isFinite(usd) || usd<=0){ toast("Montant invalide"); return; }
      const halfUsd = usd/2;
      const ethAmt  = usdToEth(halfUsd); // en ETH
      const usdcAmt = halfUsd;           // en USDC
      // 1) deposit ETH
      const vSigner = vault.connect(signer);
      toast('Dépôt ETH en cours…');
      const tx1 = await vSigner.depositETH({ value: ethers.utils.parseEther(String(ethAmt)) });
      await tx1.wait();
      // 2) approve + deposit USDC
      const uSigner = usdc.connect(signer);
      const need = ethers.utils.parseUnits(String(usdcAmt), usdcDecimals);
      const allowance = await usdc.allowance(me, VAULT_ADDRESS);
      if(allowance.lt(need)){
        toast('Approve USDC…');
        const txa = await uSigner.approve(VAULT_ADDRESS, need);
        await txa.wait();
      }
      toast('Dépôt USDC…');
      const tx2 = await vSigner.depositUSDC(need);
      await tx2.wait();
      toast('Dépôt 50/50 réussi ✅');
      $("#dlgAdd").close();
      refreshBalances(); refreshTvl();
    }catch(e){ console.error(e); toast('Échec du dépôt'); }
  };

  // ========= Vaults dépôts unitaires (+ Max)
  $("#btnVaultMaxETH").onclick = async ()=>{
    if(!me){ await connect(); }
    const bal = await provider.getBalance(me);
    const v = Math.max(0, Number(ethers.utils.formatEther(bal)) - 0.0003);
    $("#vaultEthAmount").value = v.toFixed(6);
  };
  $("#btnVaultMaxUSDC").onclick = async ()=>{
    if(!me){ await connect(); }
    const bal = await usdc.balanceOf(me);
    $("#vaultUsdcAmount").value = (Number(bal)/10**usdcDecimals).toFixed(2);
  };
  $("#btnVaultDepositETH").onclick = async ()=>{
    if(!me){ await connect(); }
    const v = parseFloat($("#vaultEthAmount").value);
    if(!isFinite(v)||v<=0){ toast('Montant invalide'); return; }
    try{
      const tx = await vault.connect(signer).depositETH({ value: ethers.utils.parseEther(String(v)) });
      await tx.wait(); toast('Déposé ✅'); refreshBalances(); refreshTvl();
    }catch(e){ console.error(e); toast('Échec du dépôt'); }
  };
  $("#btnVaultDepositUSDC").onclick = async ()=>{
    if(!me){ await connect(); }
    const v = parseFloat($("#vaultUsdcAmount").value);
    if(!isFinite(v)||v<=0){ toast('Montant invalide'); return; }
    try{
      const amt = ethers.utils.parseUnits(String(v), usdcDecimals);
      const allowance = await usdc.allowance(me, VAULT_ADDRESS);
      if(allowance.lt(amt)){
        const txa = await usdc.connect(signer).approve(VAULT_ADDRESS, amt);
        await txa.wait();
      }
      const tx = await vault.connect(signer).depositUSDC(amt);
      await tx.wait(); toast('Déposé ✅'); refreshBalances(); refreshTvl();
    }catch(e){ console.error(e); toast('Échec du dépôt'); }
  };

  // ========= Leaderboard (events → adresses uniques) + pointsOf
  async function loadParticipants(){
    try{
      const latest = await provider.getBlockNumber();
      const fromBlock = Math.max(0, latest - 50000);
      const topics = [
        vault.filters.DepositETH().topics[0],
        vault.filters.DepositUSDC().topics[0],
        vault.filters.WithdrawETH().topics[0],
        vault.filters.WithdrawUSDC().topics[0],
      ];
      const logs = await provider.getLogs({ fromBlock, toBlock:'latest', address: VAULT_ADDRESS, topics:[topics] });
      const addrs = new Set();
      for(const lg of logs){ if(lg.topics[1]) addrs.add('0x'+lg.topics[1].slice(26)); }
      return Array.from(addrs);
    }catch(e){ console.error(e); return []; }
  }
  async function refreshLeaderboard(){
    const addrs = await loadParticipants();
    if(me && !addrs.includes(me)) addrs.unshift(me);
    const rows = [];
    for(const a of addrs){
      try{
        const pScaled = await vault.pointsOf(a);
        const pts = Number(pScaled)/1e6;
        rows.push({a,pts});
      }catch{}
    }
    rows.sort((x,y)=>y.pts-x.pts);
    $("#lbRows").innerHTML = rows.map((r,i)=>`
      <tr>
        <td>${i===0?'🥇':i+1}</td>
        <td><a href="https://base-sepolia.blockscout.com/address/${r.a}" target="_blank">${r.a.slice(0,6)+'…'+r.a.slice(-4)}</a></td>
        <td>${fmt(r.pts)}</td>
      </tr>
    `).join('') || `<tr><td colspan="3" class="muted">Aucun participant détecté.</td></tr>`;
    // cache for export
    save('lb_cache', rows);
  }
  $("#btnRefreshLB").onclick = refreshLeaderboard;
  $("#btnExportCSV").onclick = ()=>{
    const rows = load('lb_cache', []);
    const csv = 'rank,address,points\n' + rows.map((r,i)=>`${i+1},${r.a},${r.pts}`).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='leaderboard.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // ========= Points "swap" (10 pts / $) via events du contrat de swap
  async function refreshMySwapPoints(){
    try{
      if(!provider || !SWAP_ADDRESS){ $("#mySwapPts").textContent = '0'; return; }
      const who = me || (await (signer ?? provider).listAccounts())[0];
      if(!who){ $("#mySwapPts").textContent = '—'; return; }

      const latest = await provider.getBlockNumber();
      const fromBlock = Math.max(0, latest - 100000);

      const iface = new ethers.utils.Interface(SWAP_ABI);
      const t1 = iface.getEventTopic("SwapETHforUSDC");
      const t2 = iface.getEventTopic("SwapUSDCforETH");

      const logs = await provider.getLogs({ address: SWAP_ADDRESS, fromBlock, toBlock: 'latest', topics: [[t1, t2]] });

      let usdTotal = 0;
      for(const lg of logs){
        const ev = iface.parseLog(lg);
        const u  = ev.args.user.toLowerCase();
        if(u !== who.toLowerCase()) continue;
        if(ev.name === "SwapETHforUSDC"){ const ethIn = Number(ethers.utils.formatEther(ev.args.ethIn)); const p8= Number(ev.args.price8)/1e8; usdTotal += ethIn * p8; }
        else if(ev.name === "SwapUSDCforETH"){ const usdcIn = Number(ev.args.usdcIn) / 10**usdcDecimals; usdTotal += usdcIn; }
      }
      const points = usdTotal * 10; // 10 pts / $
      $("#mySwapPts").textContent = who ? Math.floor(points).toLocaleString() : '—';
    }catch(e){ console.error(e); }
  }

  // ========= Onglets
  $$(".tab").forEach(t=>t.onclick=()=>{
    $$(".tab").forEach(x=>x.classList.remove('active')); t.classList.add('active');
    ["swap","pools","vaults","leaderboard","settings"].forEach(id=>{ $("#"+id).style.display = (t.dataset.tab===id)?(id==='swap'?'grid':'block'):'none'; });
    if(t.dataset.tab==="pools"){ refreshTvl(); refreshMySwapPoints(); }
    if(t.dataset.tab==="leaderboard"){ refreshLeaderboard(); }
  });

  // ========= Swap bouton (on-chain) + Approve Max + gas est.
  async function maybeWarnSlippage(from,to,amt,out){
    const slip = currentSlippage();
    const minOut = out * (1 - slip/100);
    // NB: les fonctions de swap n'ont pas de paramètre minOut, donc on affiche juste un avertissement.
    if(minOut<=0){ toast('Vérifie le montant / slippage.'); return false; }
    return true;
  }

  $("#btnApproveMax").onclick = async ()=>{
    try{
      if(!me){ await connect(); }
      const max = load('cfg_approve_max', '1000000000000');
      const amt = ethers.utils.parseUnits(String(max), usdcDecimals);
      const tx = await usdc.connect(signer).approve(SWAP_ADDRESS, amt);
      toast('Approve max en cours…'); await tx.wait(); toast('Approve confirmé ✅'); updateAllowanceBox();
    }catch(e){ console.error(e); toast('Échec approve'); }
  };

  $("#btnSwap").onclick = async ()=>{
    try{
      if(!me){ await connect(); }
      const from = $("#swapFrom").value, to=$("#swapTo").value;
      let amt = parseFloat($("#swapAmount").value);
      if(!isFinite(amt) || amt<=0){ toast("Montant invalide"); return; }
      const price = Number(price8)/1e8;
      const out = (from==='ETH')? applyFee(amt*price) : applyFee(amt/price);
      if(!(await maybeWarnSlippage(from,to,amt,out))) return;

      const swapSigner = swap.connect(signer);

      if(from==='ETH' && to==='USDC'){
        // Gas estimate affichage
        estimateGasAndShow(swapSigner.estimateGas.swapETHforUSDC({ value: ethers.utils.parseEther(String(amt)) }));
        const tx = await swapSigner.swapETHforUSDC({ value: ethers.utils.parseEther(String(amt)) });
        toast("Swap ETH→USDC envoyé…");
        await tx.wait(); toast("Swap confirmé ✅");
      } else if(from==='USDC' && to==='ETH'){
        const usdcIn = ethers.utils.parseUnits(String(amt), usdcDecimals);
        const allowance = await usdc.allowance(me, SWAP_ADDRESS);
        if(allowance.lt(usdcIn)){
          const txa = await usdc.connect(signer).approve(SWAP_ADDRESS, usdcIn);
          toast("Approve USDC…"); await txa.wait();
        }
        estimateGasAndShow(swapSigner.estimateGas.swapUSDCforETH(usdcIn));
        const tx = await swapSigner.swapUSDCforETH(usdcIn);
        toast("Swap USDC→ETH envoyé…"); await tx.wait(); toast("Swap confirmé ✅");
      } else { toast("Sélection invalide."); return; }

      await refreshBalances(); await refreshTvl(); await refreshMySwapPoints(); updateQuote(); updateAllowanceBox();
    }catch(e){ console.error(e); toast("Échec du swap"); }
  };

  // Enter = swap
  document.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' && $("#swap").style.display!=='none'){ $("#btnSwap").click(); }});

  // ========= Token import
  $("#btnImportUSDC").onclick = async ()=>{
    try{
      await window.ethereum?.request?.({
        method: 'wallet_watchAsset',
        params: { type:'ERC20', options: { address: USDC_ADDRESS, symbol:'USDC', decimals: usdcDecimals } }
      });
    }catch(e){ toast('Import token non supporté'); }
  };

  // ========= Settings (persist)
  const cfgSlipInput = $("#cfgSlippage"), cfgApprInput=$("#cfgApproveMax");
  cfgSlipInput.value = load('cfg_slippage', '0.5');
  cfgApprInput.value = load('cfg_approve_max', '1000000000000');
  $("#btnSaveCfg").onclick = ()=>{ save('cfg_slippage', cfgSlipInput.value); save('cfg_approve_max', cfgApprInput.value); toast('Paramètres sauvegardés'); updateQuote(); };

  // ========= démarrage
  async function onReady(){
    await initContracts();
    $("#vaultEthApy").textContent = APY_VAULT+'%';
    $("#vaultUsdcApy").textContent = APY_VAULT+'%';
    updateQuote();
    refreshBalances();
    refreshTvl();
    refreshLeaderboard();
    refreshMySwapPoints();
    updateAllowanceBox();
  }
  await ensureProvider().catch(()=>{});
  if(provider){ onReady(); }

  // rafraîchis prix/TVL/points toutes les 10s
  setInterval(async ()=>{
    try{
      price8 = (await swap.ethUsd()).toString();
      $("#priceBox").textContent = '$'+(Number(price8)/1e8).toLocaleString();
      updateQuote();
      await refreshTvl();
      await refreshLeaderboard();
      await refreshMySwapPoints();
    }catch(e){}
  }, 10000);
})();
</script>
</body>
</html>
