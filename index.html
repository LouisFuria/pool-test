<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FURIA DEX Â· Base Sepolia</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root{ --bg:#0b0f19; --elev:#0f1524; --card:#11172b; --txt:#e6e9ef; --muted:#94a3b8; --border:#1f2942; --pri:#8b5cf6; --ok:#10b981; --err:#ef4444 }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family:Inter,system-ui; }
    .wrap{ max-width:1100px; margin:24px auto 60px; padding:0 16px; }
    .top{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .brand{ font-family:"Space Grotesk",Inter; font-weight:800; font-size:22px }
    .muted{ color:var(--muted); font-size:12px }
    .btn{ border:1px solid var(--border); background:#fff0; color:var(--txt); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer }
    .btn.pri{ background:var(--pri); color:#000; border-color:#0000 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    nav{ display:flex; gap:8px; background:var(--elev); padding:6px; border:1px solid var(--border); border-radius:12px }
    nav button{ border:0; background:#0000; color:var(--muted); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700 }
    nav button.active{ color:var(--txt); background:#ffffff10 }
    .grid{ display:grid; gap:16px }
    @media(min-width:900px){ .g2{ grid-template-columns:1fr 1fr } .g3{ grid-template-columns: repeat(3,1fr) } }
    .card{ background:linear-gradient(180deg,#ffffff08,#0000),var(--card); border:1px solid var(--border); border-radius:16px }
    .card-h{ padding:12px 16px; border-bottom:1px solid var(--border); text-transform:uppercase; letter-spacing:.1em; color:var(--muted); font-size:12px }
    .card-c{ padding:16px }
    .stat{ display:flex; gap:12px; align-items:center; border:1px solid var(--border); background:var(--elev); border-radius:14px; padding:12px 14px }
    .val{ font-weight:800; font-size:22px }
    .small{ font-size:12px; color:var(--muted) }
    table{ width:100%; border-collapse:collapse } th,td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:left } th{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em }
    .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted) }
    .toasts{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px }
    .toast{ background:var(--elev); border:1px solid var(--border); padding:10px 12px; border-radius:10px; min-width:240px }
    .ok{ border-color:#065f46; background:#065f4628 } .err{ border-color:#7f1d1d; background:#7f1d1d28 }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">FURIA DEX <span class="muted">Â· Base Sepolia</span></div>
      <div class="muted">MVP: Swap (prix fixe) Â· Pools Â· Leaderboard (points live)</div>
    </div>
    <div class="row" style="display:flex;gap:8px;align-items:center">
      <span id="net" class="pill">RÃ©seau: â€”</span>
      <button id="connect" class="btn pri">ðŸ”— Connect</button>
    </div>
  </div>

  <div style="margin:12px 0">
    <nav>
      <button id="tab-swap" class="active">Swap</button>
      <button id="tab-pools">Pools</button>
      <button id="tab-leader">Leaderboard</button>
    </nav>
  </div>

  <!-- SWAP (simplifiÃ©, identique Ã  avant si tu lâ€™utilises) -->
  <section id="swap" class="grid g2">
    <div class="card">
      <div class="card-h">Swap</div>
      <div class="card-c grid">
        <div class="stat"><div style="flex:1">Ã€ faire</div><div class="val small">Si tu utilises le swap fixe, pense Ã  dÃ©finir SWAP_ADDRESS ci-dessous.</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-h">Infos</div>
      <div class="card-c grid">
        <div class="stat"><div style="flex:1">Prix ETH/USD</div><div class="val" id="price">â€”</div></div>
        <div class="stat"><div style="flex:1">Frais</div><div class="val" id="fees">â€”</div></div>
        <div class="stat"><div style="flex:1">TVL (Swap)</div><div class="val" id="tvlSwap">â€”</div></div>
      </div>
    </div>
  </section>

  <!-- POOLS (placeholder) -->
  <section id="pools" style="display:none">
    <div class="card">
      <div class="card-h">Pools</div>
      <div class="card-c">
        <div class="small">Ã€ venir (liste + stats). Le leaderboard fonctionne dÃ©jÃ .</div>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="leader" style="display:none">
    <div class="card">
      <div class="card-h">Mon profil</div>
      <div class="card-c grid g3">
        <div class="stat"><div style="flex:1">Mes points</div><div class="val" id="myPts">â€”</div></div>
        <div class="stat"><div style="flex:1">Mon rang</div><div class="val" id="myRank">â€”</div></div>
        <div class="stat"><div style="flex:1">Adresse</div><div class="val" id="meAddr">â€”</div></div>
      </div>
    </div>
    <div class="card" style="margin-top:16px;">
      <div class="card-h">Leaderboard (rafraÃ®chi toutes les 10s)</div>
      <div class="card-c">
        <table>
          <thead><tr><th>#</th><th>Adresse</th><th>Points</th></tr></thead>
          <tbody id="lbBody"></tbody>
        </table>
        <div class="small" style="margin-top:8px">Participants dÃ©tectÃ©s via les events du vault (dÃ©pÃ´ts/retraits rÃ©cents). Puis points lus on-chain via <code>pointsOf</code>.</div>
      </div>
    </div>
  </section>
</div>

<div class="toasts" id="toasts"></div>

<script>
(async () => {
  // ====== ADRESSES (Base Sepolia)
  const USDC_ADDRESS = "0x3F532813FEB32E1990d9c7Ca8Cb29b62C573512B";
  const POOL_ADDRESS = "0x1720e9ef567d1f29076EcE7E47CBc5F12F52F335"; // DualTokenVaultWithPoints
  const SWAP_ADDRESS = "SWAP_ADDRESS_HERE"; // optionnel si tu n'utilises pas encore le swap

  // ====== ABIs (minimum nÃ©cessaire)
  const VAULT_ABI = [
    {"type":"function","name":"pendingPointsScaled","stateMutability":"view","inputs":[{"name":"u","type":"address"}],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"pointsOf","stateMutability":"view","inputs":[{"name":"u","type":"address"}],"outputs":[{"name":"points","type":"uint256"},{"name":"decimals_","type":"uint8"}]},
    {"type":"event","name":"DepositETH","inputs":[{"name":"user","type":"address","indexed":true},{"name":"amount","type":"uint256","indexed":false}],"anonymous":false},
    {"type":"event","name":"DepositUSDC","inputs":[{"name":"user","type":"address","indexed":true},{"name":"amount","type":"uint256","indexed":false}],"anonymous":false},
    {"type":"event","name":"WithdrawETH","inputs":[{"name":"user","type":"address","indexed":true},{"name":"amount","type":"uint256","indexed":false}],"anonymous":false},
    {"type":"event","name":"WithdrawUSDC","inputs":[{"name":"user","type":"address","indexed":true},{"name":"amount","type":"uint256","indexed":false}],"anonymous":false}
  ];
  const SWAP_ABI = [
    {"type":"function","name":"ethUsd","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"feeBps","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
    {"type":"function","name":"tvl","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"},{"type":"uint256"}]}
  ];

  // ====== UI helpers
  const $ = (id)=>document.getElementById(id);
  const toastBox = $("toasts");
  function toast(msg, type="ok"){ const d=document.createElement("div"); d.className=`toast ${type}`; d.textContent=msg; toastBox.appendChild(d); setTimeout(()=>d.remove(),3000); }

  // Tabs
  const tabs = { swap:$("swap"), pools:$("pools"), leader:$("leader") };
  function showTab(k){
    for(const t of ["swap","pools","leader"]) tabs[t].style.display = (t===k)?"block":"none";
    for(const id of ["tab-swap","tab-pools","tab-leader"]) $(id).classList.remove("active");
    $("tab-"+k).classList.add("active");
  }
  $("tab-swap").onclick = ()=> showTab("swap");
  $("tab-pools").onclick = ()=> showTab("pools");
  $("tab-leader").onclick = ()=> showTab("leader");

  // Wallet
  let provider=null, signer=null, me=null;
  if(!window.ethereum){ toast("Installe MetaMask", "err"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);

  async function connect(){
    await window.ethereum.request({ method:"eth_requestAccounts" });
    signer = provider.getSigner();
    me = await signer.getAddress();
    $("connect").textContent = "âœ… "+me.slice(0,6)+"â€¦"+me.slice(-4);
    $("meAddr").textContent = me.slice(0,6)+"â€¦"+me.slice(-4);
    await updateNet();
    await initContracts();
    await bootstrapParticipants(); // construit la liste
    await refreshLeaderboard();    // premier affichage
  }
  $("connect").onclick = connect;

  async function updateNet(){
    const net = await provider.getNetwork();
    $("net").textContent = `RÃ©seau: ${Number(net.chainId)===84532 ? "Base Sepolia âœ…" : net.name+"("+net.chainId+")"}`;
    if(Number(net.chainId)!==84532){
      try{ await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:"0x14A74"}] }); }catch(e){}
    }
  }

  // Contracts
  let vaultRO, vaultIF, swapRO;
  async function initContracts(){
    vaultRO = new ethers.Contract(POOL_ADDRESS, VAULT_ABI, provider);
    vaultIF = new ethers.utils.Interface(VAULT_ABI);
    if(SWAP_ADDRESS && SWAP_ADDRESS.startsWith("0x")){
      try{ swapRO = new ethers.Contract(SWAP_ADDRESS, SWAP_ABI, provider); }catch(e){}
    }
  }

  // ===== SWAP info (si dispo)
  async function refreshSwapInfo(){
    if(!swapRO) return;
    try{
      const [p8,f,tvl] = await Promise.all([swapRO.ethUsd(), swapRO.feeBps(), swapRO.tvl()]);
      $("price").textContent = "$"+Number(ethers.utils.formatUnits(p8,8)).toLocaleString();
      $("fees").textContent = (Number(f)/100).toFixed(2)+"%";
      const [e,u] = tvl;
      $("tvlSwap").textContent = `${Number(ethers.utils.formatEther(e)).toFixed(4)} ETH + ${Number(ethers.utils.formatUnits(u,6)).toLocaleString()} USDC`;
    }catch(e){}
  }

  // ===== Participants: scan des events rÃ©cents
  const participants = new Set();
  async function bootstrapParticipants(){
    const current = await provider.getBlockNumber();
    const fromBlock = Math.max(0, current - 200000); // ~quelques semaines
    const topics = [
      ethers.utils.id("DepositETH(address,uint256)"),
      ethers.utils.id("DepositUSDC(address,uint256)"),
      ethers.utils.id("WithdrawETH(address,uint256)"),
      ethers.utils.id("WithdrawUSDC(address,uint256)")
    ];
    for(const t of topics){
      try{
        const logs = await provider.getLogs({ fromBlock, toBlock: current, address: POOL_ADDRESS, topics:[t] });
        for(const l of logs){ participants.add("0x"+l.topics[1].slice(26)); }
      }catch(e){}
    }
    if(me) participants.add(me);
  }

  // ===== Leaderboard refresh (toutes les 10s)
  async function refreshLeaderboard(){
    try{
      // Toujours inclure le compte connectÃ© si prÃ©sent
      if(me) participants.add(me);

      const addrs = Array.from(participants);
      const rows = [];

      // Lecture des points pour chacun
      for(const a of addrs){
        try{
          const res = await vaultRO.pointsOf(a);
          const pts = Number(ethers.utils.formatUnits(res.points || res[0] || "0", (res.decimals_ || res[1] || 6)));
          rows.push({ a, pts });
        }catch(e){}
      }

      // Tri dÃ©croissant
      rows.sort((x,y)=> y.pts - x.pts);

      // Rendu tableau
      const body = $("lbBody"); body.innerHTML = "";
      rows.forEach((r,i)=>{
        const tr = document.createElement("tr");
        const medal = i===0?"ðŸ¥‡":i===1?"ðŸ¥ˆ":i===2?"ðŸ¥‰":(i+1);
        tr.innerHTML = `<td>${medal}</td><td><a href="https://sepolia.basescan.org/address/${r.a}" target="_blank" style="color:#fff">${r.a.slice(0,6)}â€¦${r.a.slice(-4)}</a></td><td>${r.pts.toLocaleString(undefined,{maximumFractionDigits:2})}</td>`;
        body.appendChild(tr);
      });

      // Mon rang + mes points
      if(me){
        const mine = rows.findIndex(r=> r.a.toLowerCase()===me.toLowerCase());
        $("myRank").textContent = mine>=0 ? (mine+1) : "â€”";
        const my = rows.find(r=> r.a.toLowerCase()===me.toLowerCase());
        $("myPts").textContent = my ? my.pts.toLocaleString(undefined,{maximumFractionDigits:2}) : "â€”";
      }
    }catch(e){ console.error(e); }
  }

  // Intervalles
  setInterval(refreshLeaderboard, 10000);
  setInterval(refreshSwapInfo, 15000);

  // Init (sans connexion encore)
  await updateNet();
  await initContracts();
  await refreshSwapInfo();
  await bootstrapParticipants();
  await refreshLeaderboard();

  if(window.ethereum){
    window.ethereum.on?.("accountsChanged", ()=> location.reload());
    window.ethereum.on?.("chainChanged", ()=> location.reload());
  }
})();
</script>
</body>
</html>
