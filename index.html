<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FURIA DEX · Base Sepolia</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://unpkg.com" />
<style>
  :root{
    --bg:#0b0f17;--card:#111827;--muted:#a3b0c2;--txt:#e6eefc;
    --primary:#7c5cff;--primary-2:#6b4cff;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;
    --chip:#1f2937;--chip2:#0f172a;--border:#1f2a3a
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:500 16px/1.4 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .between{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .nav{display:flex;gap:10px;flex-wrap:wrap}
  .tab{padding:10px 16px;border-radius:10px;background:var(--chip);cursor:pointer;user-select:none}
  .tab.active{outline:2px solid var(--primary);background:linear-gradient(180deg,var(--chip),#172033)}
  .badge{padding:6px 10px;border-radius:999px;background:var(--chip2);color:var(--muted);font-size:12px}
  .btn{padding:12px 18px;border-radius:14px;background:var(--primary);border:0;color:#fff;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:#1b2333;color:#dbe7ff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
  h1{margin:0 0 10px 0;font-weight:800;font-size:28px;letter-spacing:.2px}
  h2{margin:0 0 12px 0;font-weight:800;font-size:18px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}
  .input,select{width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);background:#0e1421;color:var(--txt);font-size:16px}
  .kk{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:10px 14px;border-radius:999px;background:#0f172a;cursor:pointer}
  .chip.active{outline:2px solid var(--primary);background:#1b2337}
  .label{color:var(--muted);font-size:13px;margin-bottom:6px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .right{display:flex;justify-content:flex-end}
  .stat{display:flex;flex-direction:column;gap:4px;padding:18px;border-radius:16px;background:var(--card);border:1px solid var(--border)}
  .stat b{font-size:28px}
  .toast{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .toast .t{background:#132034;color:#cfe1ff;border:1px solid #213148;border-radius:12px;padding:12px 14px;max-width:520px}
  .muted{color:var(--muted)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--border);padding:12px 8px;text-align:left}
  .pill{padding:6px 10px;border-radius:10px;background:#0e1729;font-size:13px}
  .modalMask{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;min-width:320px;max-width:420px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="between">
      <div>
        <h1>FURIA DEX <span class="badge">Base Sepolia</span></h1>
        <div class="muted">Swap (10 pts/$) · Pools (1 pt/$/min) · Vaults (1 pt/$/min) · Leaderboard</div>
      </div>
      <div class="between" style="gap:10px">
        <div id="netTag" class="badge">Réseau: —</div>
        <button id="btnConnect" class="btn">Connect Wallet</button>
      </div>
    </div>

    <div class="nav" style="margin:14px 0 18px">
      <div class="tab active" data-tab="swap">Swap</div>
      <div class="tab" data-tab="pools">Pools</div>
      <div class="tab" data-tab="vaults">Vaults</div>
      <div class="tab" data-tab="leaderboard">Leaderboard</div>
    </div>

    <!-- SWAP -->
    <section id="tab-swap">
      <div class="grid">
        <div class="card">
          <h2>SWAP ETH ↔ USDC · <span class="muted">Règle points : 10 pts / $ swapé</span></h2>
          <div class="row">
            <div style="flex:1">
              <div class="label">From</div>
              <select id="swapFrom" class="input">
                <option value="ETH">ETH</option>
                <option value="USDC">USDC</option>
              </select>
            </div>
            <div class="between" style="align-items:flex-end">
              <button id="btnFlip" class="chip">⇄</button>
            </div>
            <div style="flex:1">
              <div class="label">To</div>
              <select id="swapTo" class="input">
                <option value="USDC">USDC</option>
                <option value="ETH">ETH</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="label">Montant</div>
            <input id="swapAmount" class="input" placeholder="0.0" />
            <div class="kk" style="margin-top:10px">
              <span class="chip" data-pct="25">25%</span>
              <span class="chip" data-pct="50">50%</span>
              <span class="chip" data-pct="75">75%</span>
              <span class="chip" data-pct="100">100%</span>
            </div>
          </div>

          <div style="margin-top:14px">
            <div class="label">You Receive</div>
            <div id="youReceive" class="input" style="height:auto;padding:14px 16px">—</div>
          </div>

          <div class="between" style="margin-top:12px">
            <div id="balances" class="muted">Solde: —</div>
            <button id="btnSwap" class="btn">Swap</button>
          </div>
        </div>

        <div class="card">
          <h2>INFOS (SWAP)</h2>
          <div class="stat">
            <span class="muted">Prix ETH/USD</span>
            <b id="statPrice">$—</b>
          </div>
          <div class="stat" style="margin-top:12px">
            <span class="muted">Frais</span>
            <b id="statFee">—</b>
          </div>
          <div class="stat" style="margin-top:12px">
            <span class="muted">TVL (équiv. ETH)</span>
            <b id="statTVL">—</b>
          </div>
        </div>
      </div>
    </section>

    <!-- POOLS -->
    <section id="tab-pools" style="display:none">
      <div class="row">
        <div class="stat" style="flex:1">
          <span class="muted">TVL (équiv. ETH)</span>
          <b id="poolsTVL">—</b>
        </div>
        <div class="stat" style="flex:1">
          <span class="muted">Volume ~24h</span>
          <b id="poolsVol">$0</b>
        </div>
        <div class="stat" style="flex:1">
          <span class="muted">Mes points (swap)</span>
          <b id="mySwapPts">0</b>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>POOLS (POINTS: 1 pt / $ / min)</h2>
        <table class="table">
          <thead><tr>
            <th>Pair</th><th>APY</th><th>TVL (ETH)</th><th>Points règle</th><th class="right">Action</th>
          </tr></thead>
          <tbody id="poolsBody">
            <!-- Row ETH/USDC -->
          </tbody>
        </table>
        <div class="muted" style="margin-top:10px">⚠️ Dépôt “Pools” utilise le **Vault**. Le bouton ADD ouvre un dépôt **50/50** (ETH/USDC) calculé au prix courant.</div>
      </div>
    </section>

    <!-- VAULTS -->
    <section id="tab-vaults" style="display:none">
      <div class="row">
        <div class="stat" style="flex:1">
          <span class="muted">TVL Vault (équiv. ETH)</span>
          <b id="vaultsTVL">—</b>
        </div>
        <div class="stat" style="flex:1">
          <span class="muted">Mes points (vault)</span>
          <b id="myVaultPts">0</b>
        </div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="card">
          <h2>VAULT ETH</h2>
          <div class="muted">APY <b class="mono">25%</b> · Règle points: <b>1 pt / $ / min</b></div>
          <div class="label" style="margin-top:12px">Montant en ETH</div>
          <input id="vEthAmt" class="input" placeholder="ex. 0.2" />
          <div class="right" style="margin-top:10px">
            <button id="btnDepositETH" class="btn">Déposer</button>
          </div>
        </div>

        <div class="card">
          <h2>VAULT USDC</h2>
          <div class="muted">APY <b class="mono">25%</b> · Règle points: <b>1 pt / $ / min</b></div>
          <div class="label" style="margin-top:12px">Montant en USDC</div>
          <input id="vUsdcAmt" class="input" placeholder="ex. 200" />
          <div class="right" style="margin-top:10px">
            <button id="btnDepositUSDC" class="btn">Déposer</button>
          </div>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="tab-leaderboard" style="display:none">
      <div class="card">
        <h2>LEADERBOARD (VAULT POINTS)</h2>
        <table class="table">
          <thead><tr><th>#</th><th>Adresse</th><th>Points</th></tr></thead>
          <tbody id="lbBody"><tr><td colspan="3" class="muted">Chargement…</td></tr></tbody>
        </table>
        <div class="muted" style="margin-top:10px">Règle: <b>1 pt / $ / min</b> (lecture on-chain via <code>pointsOf</code>, refresh 10s).</div>
      </div>
    </section>

    <!-- MODAL POOL ADD -->
    <div id="mask" class="modalMask">
      <div class="modal">
        <h2>Déposer dans la pool</h2>
        <div class="label">Total (USD) à déposer (50% ETH / 50% USDC)</div>
        <input id="poolUsd" class="input" placeholder="ex. 100" />
        <div class="right" style="margin-top:12px;gap:8px">
          <button id="mCancel" class="btn ghost">Annuler</button>
          <button id="mConfirm" class="btn">Déposer</button>
        </div>
        <div class="muted" style="margin-top:10px">L’app enverra 50% en ETH (au prix actuel) + 50% en USDC (approve auto).</div>
      </div>
    </div>

    <div class="toast" id="toasts"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script>
/*** ====== CONFIG ====== ***/
const CHAIN_ID = 84532; // Base Sepolia
const ADDR = {
  USDC: "0x3F532813FEB32E1990d9c7Ca8Cb29b62C573512B",
  VAULT: "0xfC39B74a0c3AD291f88224ec620410c32f3659e4",
  SWAP:  "0x9965B8ef813E6247c6788AF7836756a579474484",
};
const RPCS = [
  "https://sepolia.base.org",
  "https://base-sepolia-rpc.publicnode.com",
  "https://base-sepolia.infura.io/v3/00000000000000000000000000000000"
];

/*** ====== ABIs minimales ====== ***/
const ERC20_ABI = [
  "function decimals() view returns(uint8)",
  "function balanceOf(address) view returns(uint256)",
  "function allowance(address,address) view returns(uint256)",
  "function approve(address spender,uint256) returns(bool)"
];

const VAULT_ABI = [
  "function totalETH() view returns(uint256)",
  "function totalUSDC() view returns(uint256)",
  "function depositETH() payable",
  "function depositUSDC(uint256 amount)",
  "function pointsOf(address u) view returns(uint256)",
  "event DepositETH(address indexed user,uint256 amount)",
  "event DepositUSDC(address indexed user,uint256 amount)"
];

const SWAP_ABI = [
  "function USDC() view returns(address)",
  "function ethUsd() view returns(uint256)",     // 8 décimales
  "function feeBps() view returns(uint256)",     // e.g. 30 = 0.30%
  "function swapETHforUSDC() payable",           // emit event
  "function swapUSDCforETH(uint256 usdcIn)",     // needs approve
  "event SwapETHforUSDC(address indexed user,uint256 ethIn,uint256 usdcOut,uint256 price8,uint256 feeBps)",
  "event SwapUSDCforETH(address indexed user,uint256 usdcIn,uint256 ethOut,uint256 price8,uint256 feeBps)"
];

/*** ====== Helpers ====== ***/
const $ = (q)=>document.querySelector(q);
const toasts = $("#toasts");
function toast(msg){const d=document.createElement("div");d.className="t";d.textContent=msg;toasts.appendChild(d);setTimeout(()=>d.remove(),4200);}

function short(a){return a? a.slice(0,6)+"…"+a.slice(-4):"—"}
function fmt(n,dec=4){if(n===null||n===undefined||Number.isNaN(+n))return "—";return (+n).toLocaleString(undefined,{maximumFractionDigits:dec})}

/*** ====== State & provider ====== ***/
let provider = new ethers.providers.JsonRpcProvider(RPCS[0],{chainId:CHAIN_ID,name:"base-sepolia"});
let web3, signer, me;
let USDC = new ethers.Contract(ADDR.USDC, ERC20_ABI, provider);
let VAULT = new ethers.Contract(ADDR.VAULT, VAULT_ABI, provider);
let SWAP  = new ethers.Contract(ADDR.SWAP , SWAP_ABI , provider);
let usdcDecimals = 6;

async function ensureDecimals(){
  try{ usdcDecimals = await USDC.decimals(); }catch{}
}

/*** ====== Connexion wallet ====== ***/
async function connect(silent=false){
  if(!window.ethereum){ toast("MetaMask introuvable"); return; }
  try{
    const accs = await window.ethereum.request({method:"eth_requestAccounts"});
    if(!accs?.length) return;
    web3 = new ethers.providers.Web3Provider(window.ethereum,"any");
    signer = web3.getSigner();
    me = await signer.getAddress();

    // Network tag
    const net = await web3.getNetwork();
    $("#netTag").textContent = `Réseau: ${net.chainId||net.name}`;
    if(net.chainId !== CHAIN_ID) toast("Change de réseau → Base Sepolia (84532)");

    $("#btnConnect").textContent = short(me);
    localStorage.setItem("furia_autoconnect","1");

    // listeners
    window.ethereum.removeAllListeners?.("accountsChanged");
    window.ethereum.removeAllListeners?.("chainChanged");
    window.ethereum.on("accountsChanged", async (a)=>{
      if(!a?.length){ $("#btnConnect").textContent="Connect Wallet"; me=undefined; return; }
      me = a[0]; $("#btnConnect").textContent = short(me); await refreshBalances();
    });
    window.ethereum.on("chainChanged", async ()=>{
      web3 = new ethers.providers.Web3Provider(window.ethereum,"any");
      signer = web3.getSigner();
      await refreshAll();
    });

    await refreshAll();
  }catch(e){ console.error(e); if(!silent) toast("Connexion impossible."); }
}

/*** ====== UI wiring ====== ***/
function wireTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab;
      ["swap","pools","vaults","leaderboard"].forEach(k=>{
        $("#tab-"+k).style.display = (k===id)?"block":"none";
      })
    }
  })
}
function wireUI(){
  $("#btnConnect").onclick = ()=>connect(false);
  $("#btnFlip").onclick = ()=>{
    const a=$("#swapFrom"), b=$("#swapTo");
    const tmp=a.value; a.value=b.value; b.value=tmp; computeReceive();
  };
  document.querySelectorAll(".chip[data-pct]").forEach(ch=>{
    ch.onclick=()=>{
      ch.parentElement.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
      ch.classList.add("active");
      fillPct(+ch.dataset.pct);
    }
  });
  $("#swapAmount").oninput = computeReceive;
  $("#swapFrom").onchange = computeReceive;
  $("#swapTo").onchange   = computeReceive;
  $("#btnSwap").onclick   = doSwap;

  // Pools row
  renderPoolsRow();
  $("#poolsBody").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-add]");
    if(btn){ openModal(); }
  });

  // Modal
  $("#mCancel").onclick = closeModal;
  $("#mConfirm").onclick = depositPool;

  // Vaults
  $("#btnDepositETH").onclick = depositETH;
  $("#btnDepositUSDC").onclick = depositUSDC;
}

function openModal(){ $("#mask").style.display="flex"; }
function closeModal(){ $("#mask").style.display="none"; $("#poolUsd").value=""; }

/*** ====== Calculs affichage “You receive” ====== ***/
let lastPrice=0, lastFeeBps=0;

async function loadSwapStatics(){
  try{
    lastPrice = +(await SWAP.ethUsd())/1e8;   // $/ETH
  }catch{ lastPrice = 0; }
  try{
    lastFeeBps = +(await SWAP.feeBps());       // e.g. 30
  }catch{ lastFeeBps = 0; }

  $("#statPrice").textContent = lastPrice? ("$"+fmt(lastPrice,2)) : "$—";
  $("#statFee").textContent   = lastFeeBps? (fmt(lastFeeBps/100,2)+"%") : "—";
}

function computeReceive(){
  const from=$("#swapFrom").value, to=$("#swapTo").value;
  let amt = parseFloat($("#swapAmount").value||"0");
  if(!amt || amt<=0 || !lastPrice){ $("#youReceive").textContent="—"; return; }
  let out=0;
  if(from==="ETH" && to==="USDC"){
    const gross = amt*lastPrice;
    out = gross*(1 - lastFeeBps/10000);
    $("#youReceive").textContent = fmt(out,6)+" USDC";
  }else if(from==="USDC" && to==="ETH"){
    const gross = amt/lastPrice;
    out = gross*(1 - lastFeeBps/10000);
    $("#youReceive").textContent = fmt(out,6)+" ETH";
  }else{
    $("#youReceive").textContent="—";
  }
}

function fillPct(p){
  if(!me){ toast("Connecte ton wallet"); return; }
  const from=$("#swapFrom").value;
  const target = $("#swapAmount");
  const [eth,usdc] = balancesCache;
  if(from==="ETH"){
    const v = Math.max(0,(eth||0))*p/100;
    target.value = v>0? String(v) : "";
  }else{
    const v = Math.max(0,(usdc||0))*p/100;
    target.value = v>0? String(v) : "";
  }
  computeReceive();
}

/*** ====== Balances & TVL ====== ***/
let balancesCache=[0,0];

async function refreshBalances(){
  try{
    if(!me){ $("#balances").textContent="Solde: —"; return; }
    const e = await provider.getBalance(me);
    const u = await USDC.balanceOf(me);
    const eth = +ethers.utils.formatEther(e);
    const usdc = +ethers.utils.formatUnits(u,usdcDecimals);
    balancesCache=[eth,usdc];
    $("#balances").textContent = `Solde: ${fmt(eth,4)} ETH · ${fmt(usdc,2)} USDC`;
  }catch{}
}

async function refreshTVL(){
  try{
    const tEth = +(ethers.utils.formatEther(await VAULT.totalETH()));
    const tUsdc= +(ethers.utils.formatUnits(await VAULT.totalUSDC(), usdcDecimals));
    const tvlEthEq = tEth + (lastPrice? (tUsdc/lastPrice) : 0);
    $("#statTVL").textContent   = fmt(tvlEthEq,4)+" ETH";
    $("#poolsTVL").textContent  = fmt(tvlEthEq,4)+" ETH";
    $("#vaultsTVL").textContent = fmt(tvlEthEq,4)+" ETH";
    // Line for Pools row
    $("#rowTVL").textContent    = fmt(tvlEthEq,4)+" ETH";
  }catch{}
}

/*** ====== Swap on-chain ====== ***/
async function doSwap(){
  if(!signer){ toast("Connecte ton wallet"); return; }
  const from=$("#swapFrom").value, to=$("#swapTo").value;
  let amt = parseFloat($("#swapAmount").value||"0");
  if(!amt || amt<=0){ toast("Montant invalide"); return; }

  try{
    if(from==="ETH" && to==="USDC"){
      const tx = await (new ethers.Contract(ADDR.SWAP,SWAP_ABI,signer))
        .swapETHforUSDC({value:ethers.utils.parseEther(String(amt))});
      toast("Swap ETH→USDC envoyé…");
      await tx.wait();
    }else if(from==="USDC" && to==="ETH"){
      // Approve si besoin
      const need = ethers.utils.parseUnits(String(amt), usdcDecimals);
      const USDCw = new ethers.Contract(ADDR.USDC, ERC20_ABI, signer);
      const allow = await USDCw.allowance(me, ADDR.SWAP);
      if(allow.lt(need)){
        const aTx = await USDCw.approve(ADDR.SWAP, need);
        toast("Approve USDC…"); await aTx.wait();
      }
      const tx = await (new ethers.Contract(ADDR.SWAP,SWAP_ABI,signer)).swapUSDCforETH(need);
      toast("Swap USDC→ETH envoyé…");
      await tx.wait();
    }else{
      toast("Sélection invalide");
      return;
    }
    await refreshAll();
    computeReceive();
    toast("Swap confirmé ✅");
  }catch(e){ console.error(e); toast("Échec du swap"); }
}

/*** ====== Pools (ADD 50/50) ====== ***/
function renderPoolsRow(){
  const tb = $("#poolsBody");
  tb.innerHTML = `
    <tr>
      <td>ETH / USDC</td>
      <td>20%</td>
      <td id="rowTVL">—</td>
      <td>1 pt / $ / min</td>
      <td class="right"><button class="btn" data-add="1">ADD</button></td>
    </tr>
  `;
}

async function depositPool(){
  if(!signer){ toast("Connecte ton wallet"); return; }
  const usd = parseFloat($("#poolUsd").value||"0");
  if(!usd || usd<=0 || !lastPrice){ toast("Montant invalide"); return; }

  // 50% en USD ⇢ ETH, 50% en USD ⇢ USDC
  const usdHalf = usd/2;
  const ethNeeded = usdHalf / lastPrice;              // en ETH
  const usdcNeeded = usdHalf;                          // en USDC unités "entières"

  try{
    // Approve USDC
    const USDCw = new ethers.Contract(ADDR.USDC, ERC20_ABI, signer);
    const need = ethers.utils.parseUnits(String(usdcNeeded), usdcDecimals);
    const allow = await USDCw.allowance(me, ADDR.VAULT);
    if(allow.lt(need)){
      const aTx = await USDCw.approve(ADDR.VAULT, need);
      toast("Approve USDC…"); await aTx.wait();
    }

    // depositUSDC
    const VAULTw = new ethers.Contract(ADDR.VAULT, VAULT_ABI, signer);
    const tx1 = await VAULTw.depositUSDC(need);
    toast("Dépot USDC…"); await tx1.wait();

    // depositETH
    const tx2 = await VAULTw.depositETH({value:ethers.utils.parseEther(String(ethNeeded))});
    toast("Dépot ETH…"); await tx2.wait();

    closeModal();
    await refreshAll();
    toast("Dépôt 50/50 confirmé ✅");
  }catch(e){ console.error(e); toast("Échec du dépôt"); }
}

/*** ====== Vault deposit buttons ====== ***/
async function depositETH(){
  if(!signer){ toast("Connecte ton wallet"); return; }
  const v = parseFloat($("#vEthAmt").value||"0");
  if(!v || v<=0){ toast("Montant invalide"); return; }
  try{
    const VAULTw = new ethers.Contract(ADDR.VAULT, VAULT_ABI, signer);
    const tx = await VAULTw.depositETH({value:ethers.utils.parseEther(String(v))});
    toast("Dépôt ETH…"); await tx.wait(); await refreshAll(); toast("OK ✅");
  }catch(e){ console.error(e); toast("Échec dépôt ETH"); }
}
async function depositUSDC(){
  if(!signer){ toast("Connecte ton wallet"); return; }
  const v = parseFloat($("#vUsdcAmt").value||"0");
  if(!v || v<=0){ toast("Montant invalide"); return; }
  try{
    const USDCw = new ethers.Contract(ADDR.USDC, ERC20_ABI, signer);
    const need = ethers.utils.parseUnits(String(v), usdcDecimals);
    const allow = await USDCw.allowance(me, ADDR.VAULT);
    if(allow.lt(need)){ const a=await USDCw.approve(ADDR.VAULT, need); toast("Approve USDC…"); await a.wait(); }
    const VAULTw = new ethers.Contract(ADDR.VAULT, VAULT_ABI, signer);
    const tx = await VAULTw.depositUSDC(need);
    toast("Dépôt USDC…"); await tx.wait(); await refreshAll(); toast("OK ✅");
  }catch(e){ console.error(e); toast("Échec dépôt USDC"); }
}

/*** ====== Leaderboard ====== ***/
async function refreshLeaderboard(){
  try{
    const lb = new Map(); // addr -> points
    // 1) scan des events récents pour lister les participants
    const latest = await provider.getBlockNumber();
    const fromBlock = Math.max(0, latest - 60_000); // ~fenêtre large
    const topicsDepEth  = ethers.utils.id("DepositETH(address,uint256)");
    const topicsDepUsdc = ethers.utils.id("DepositUSDC(address,uint256)");

    const logsEth  = await provider.getLogs({fromBlock,toBlock:"latest",address:ADDR.VAULT,topics:[topicsDepEth]});
    const logsUsdc = await provider.getLogs({fromBlock,toBlock:"latest",address:ADDR.VAULT,topics:[topicsDepUsdc]});

    const addrs = new Set();
    [...logsEth, ...logsUsdc].forEach(l=>{
      const addr = "0x"+l.topics[1].slice(26);
      addrs.add(addr.toLowerCase());
    });
    if(me) addrs.add(me.toLowerCase());

    // 2) lecture on-chain des points
    const arr = Array.from(addrs);
    for(const a of arr){
      try{
        const p = await VAULT.pointsOf(a);
        const pts = Number(ethers.utils.formatUnits(p, 0)); // points en unités "entières" sur le contrat
        lb.set(a, pts);
      }catch{}
    }

    // 3) render
    const rows = [...lb.entries()].sort((x,y)=>y[1]-x[1]).map((e,i)=>{
      const [addr, pts] = e;
      return `<tr><td>${i===0?"🥇":i+1}</td><td class="mono"><a href="https://base-sepolia.blockscout.com/address/${addr}" target="_blank">${short(addr)}</a></td><td>${fmt(pts,0)}</td></tr>`;
    });
    $("#lbBody").innerHTML = rows.length? rows.join("") : `<tr><td colspan="3" class="muted">Aucun participant détecté…</td></tr>`;

    // Mes points
    if(me){
      try{
        const p = await VAULT.pointsOf(me);
        $("#myVaultPts").textContent = fmt(Number(ethers.utils.formatUnits(p,0)),0);
      }catch{}
    }
  }catch(e){ console.warn("LB fail",e); }
}

/*** ====== Refresh global ====== ***/
async function refreshAll(){
  await ensureDecimals();
  await loadSwapStatics();
  await refreshTVL();
  await refreshBalances();
  computeReceive();
  await refreshLeaderboard();
}

/*** ====== Init ====== ***/
wireTabs(); wireUI();

(async function init(){
  try{
    await ensureDecimals();
    await loadSwapStatics();
    renderPoolsRow();
    computeReceive();

    if(window.ethereum && localStorage.getItem("furia_autoconnect")==="1"){
      try{ await connect(true); }catch(e){ console.warn("autoconnect",e); }
    }

    await refreshAll();
    setInterval(async()=>{ await loadSwapStatics(); await refreshTVL(); await refreshLeaderboard(); }, 10_000);
  }catch(e){ console.error("init",e); }
})();
</script>
</body>
</html>
